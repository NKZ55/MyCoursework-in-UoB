---
title: "Electricity load forecasting"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, results='hide', warning=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(ggthemes)
library(plotly)
library(xray)
library(forecast)
library(prophet)
library(imputeTS)
library(MAPA)
library(fable)
```


```{r}
bel2020=read_csv('bel2020.csv')
bel2021=read_csv('bel2021.csv')
bel2022=read_csv('bel2022.csv')

bel2020_hourly=read_csv('bel2020_hourly.csv')
bel2021_hourly=read_csv('bel2021_hourly.csv')
bel2022_hourly=read_csv('bel2022_hourly.csv')

fin2020=read_csv('fin2020.csv')
fin2021=read_csv('fin2021.csv')
fin2022=read_csv('fin2022.csv')

fra2020=read_csv('fra2020.csv')
fra2021=read_csv('fra2021.csv')
fra2022=read_csv('fra2022.csv')

ger2020A1=read_csv('ger2020A1.csv')
ger2021A1=read_csv('ger2021A1.csv')
ger2022A1=read_csv('ger2022A1.csv')
ger2020A2=read_csv('ger2020A2.csv')
ger2021A2=read_csv('ger2021A2.csv')
ger2022A2=read_csv('ger2022A2.csv')
ger2020A3=read_csv('ger2020A3.csv')
ger2021A3=read_csv('ger2021A3.csv')
ger2022A3=read_csv('ger2022A3.csv')
ger2020A4=read_csv('ger2020A4.csv')
ger2021A4=read_csv('ger2021A4.csv')
ger2022A4=read_csv('ger2022A4.csv')

ger2020=read_csv('ger2020.csv')
ger2021=read_csv('ger2021.csv')
ger2022=read_csv('ger2022.csv')

ger2020_hourly=read_csv('ger2020_hourly.csv')
ger2021_hourly=read_csv('ger2021_hourly.csv')
ger2022_hourly=read_csv('ger2022_hourly.csv')

#ger2020A1_hourly=read_csv('ger2020A1_hourly.csv')
#ger2021A1_hourly=read_csv('ger2021A1_hourly.csv')
#ger2022A1_hourly=read_csv('ger2022A1_hourly.csv')
#ger2020A2_hourly=read_csv('ger2020A2_hourly.csv')
#ger2021A2_hourly=read_csv('ger2021A2_hourly.csv')
#ger2022A2_hourly=read_csv('ger2022A2_hourly.csv')
#ger2020A3_hourly=read_csv('ger2020A3_hourly.csv')
#ger2021A3_hourly=read_csv('ger2021A3_hourly.csv')
#ger2022A3_hourly=read_csv('ger2022A3_hourly.csv')
#ger2020A4_hourly=read_csv('ger2020A4_hourly.csv')
#ger2021A4_hourly=read_csv('ger2021A4_hourly.csv')
#ger2022A4_hourly=read_csv('ger2022A4_hourly.csv')

gre2020=read_csv('gre2020.csv')
gre2021=read_csv('gre2021.csv')
gre2022=read_csv('gre2022.csv')

ita2020=read_csv('ita2020.csv')
ita2021=read_csv('ita2021.csv')
ita2022=read_csv('ita2022.csv')

pol2020=read_csv('pol2020.csv')
pol2021=read_csv('pol2021.csv')
pol2022=read_csv('pol2022.csv')

rom=read_csv("romhourly.csv")
rom2021_15=read_csv("rom2021_15min.csv")
rom2022_15=read_csv("rom2022_15min.csv")

spa2020=read_csv('spa2020.csv')
spa2021=read_csv('spa2021.csv')
spa2022=read_csv('spa2022.csv')

swe2020=read_csv('swe2020.csv')
swe2021=read_csv('swe2021.csv')
swe2022=read_csv('swe2022.csv')

```

```{r}
bel=rbind(bel2020,bel2021,bel2022)
bel_hourly=rbind(bel2020_hourly,bel2021_hourly,bel2022_hourly)

fin=rbind(fin2020,fin2021,fin2022)

fra=rbind(fra2020,fra2021,fra2022)

gerA1=rbind(ger2020A1,ger2021A1,ger2022A1)
gerA2=rbind(ger2020A2,ger2021A2,ger2022A2)
gerA3=rbind(ger2020A3,ger2021A3,ger2022A3)
gerA4=rbind(ger2020A4,ger2021A4,ger2022A4)
ger_hourly=rbind(ger2020_hourly,ger2021_hourly,ger2022_hourly)

ger=rbind(ger2020,ger2021,ger2022)

gre=rbind(gre2020,gre2021,gre2022)

ita=rbind(ita2020,ita2021,ita2022)

pol=rbind(pol2020,pol2021,pol2022)

rom_15=rbind(rom2021_15,rom2022_15)

spa=rbind(spa2020,spa2021,spa2022)

swe=rbind(swe2020,swe2021,swe2022)
```


```{r}
bel$TimeUTC=dmy_hm(bel$TimeUTC)
bel$ActualTotalLoad=as.double(bel$ActualTotalLoad)
bel_hourly$TimeUTC=dmy_hm(bel_hourly$TimeUTC)
bel_hourly$ActualTotalLoad=as.double(bel_hourly$ActualTotalLoad)

fin$TimeUTC=dmy_hm(fin$TimeUTC)
fin$ActualTotalLoad=as.double(fin$ActualTotalLoad)

fra$TimeUTC=dmy_hm(fra$TimeUTC)
fra$ActualTotalLoad=as.double(fra$ActualTotalLoad) # in case of N/A values

gerA1$TimeUTC=dmy_hm(gerA1$TimeUTC)
gerA1$ActualTotalLoad=as.double(gerA1$ActualTotalLoad)
gerA2$TimeUTC=dmy_hm(gerA2$TimeUTC)
gerA2$ActualTotalLoad=as.double(gerA2$ActualTotalLoad)
gerA3$TimeUTC=dmy_hm(gerA3$TimeUTC)
gerA3$ActualTotalLoad=as.double(gerA3$ActualTotalLoad)
gerA4$TimeUTC=dmy_hm(gerA4$TimeUTC)
gerA4$ActualTotalLoad=as.double(gerA4$ActualTotalLoad)
ger_hourly$TimeUTC=dmy_hm(ger_hourly$TimeUTC)
ger_hourly$ActualTotalLoad=as.double(ger_hourly$ActualTotalLoad)
ger$TimeUTC=dmy_hm(ger$TimeUTC)
ger$ActualTotalLoad=as.double(ger$ActualTotalLoad)


gre$TimeUTC=dmy_hm(gre$TimeUTC)
gre$ActualTotalLoad=as.double(gre$ActualTotalLoad)

ita$TimeUTC=dmy_hm(ita$TimeUTC)
ita$ActualTotalLoad=as.double(ita$ActualTotalLoad)

pol$TimeUTC=dmy_hm(pol$TimeUTC)
pol$ActualTotalLoad=as.double(pol$ActualTotalLoad)

rom_15$TimeUTC=dmy_hm(rom_15$TimeUTC)
rom_15$ActualTotalLoad=as.double(rom_15$ActualTotalLoad)

spa$TimeUTC=dmy_hm(spa$TimeUTC)
spa$ActualTotalLoad=as.double(spa$ActualTotalLoad)

swe$TimeUTC=dmy_hm(swe$TimeUTC)
swe$ActualTotalLoad=as.double(swe$ActualTotalLoad)
```


```{r}
anomalies(bel)
anomalies(bel_hourly)
anomalies(fin)
anomalies(fra)
anomalies(ger)
anomalies(ger_hourly)
anomalies(gerA1)
anomalies(gerA2)
anomalies(gerA3)
anomalies(gerA4)
anomalies(gre)
anomalies(ita)
anomalies(pol)
anomalies(rom)
anomalies(rom_15)
anomalies(spa)
anomalies(swe)
```

```{r}
rom_15$ActualTotalLoad=as.vector(na_ma(ts(rom_15$ActualTotalLoad,freq=24*4)))

write_csv(rom_15,file='romhourly.csv')
```


```{r}
(bel %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()) %>%
  ggplotly()
```

```{r}
bel_hourly %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()
```

```{r}
(fin %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()) %>%
  ggplotly()
```

The daily seasonality within a week is quite strange in Finland. Sometimes the electricity demand in weekend is higher than weekday, sometimes lower. Hard to include this seasonality.


```{r}
(fra2021 %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()) %>%
  ggplotly()
```

```{r}
(ger2021 %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()) %>%
  ggplotly()
```

```{r}
(gre %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()) %>%
  ggplotly()
```

```{r}
(swe %>%
  ggplot(aes(x=TimeUTC,y=ActualTotalLoad)) +
  geom_line() +
  theme_stata()) %>%
  ggplotly()
```

# Finland

## Decomposition

```{r}
finLoad=ts(fin$ActualTotalLoad,freq=24)
finLoad=na_ma(finLoad)
finLoad_test=tail(finLoad,24*7)
finLoad_train=head(finLoad,length(finLoad)-24*7)
```

```{r}
length(as.vector(tsoutliers(finLoad)$index))/length(finLoad)
```


```{r}
finLoad_train %>%
  decompose() %>% 
  autoplot()
```

```{r}
#2week
finLoad1=msts(fin$ActualTotalLoad,seasonal.periods = c(24,24*7))
#finLoad_test1=tail(finLoad,24*7)
#finLoad_train1=tail(head(finLoad,length(finLoad)-24*7),24*7*2)

#1month
#finLoad1=msts(fin$ActualTotalLoad,seasonal.periods = c(24,24*7))
#finLoad_test1=tail(finLoad,24*7)
#finLoad_train1=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)

#3month
finLoad2=msts(fin$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
#finLoad_test1=tail(finLoad,24*7)
#finLoad_train1=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25*3)

#6month
#finLoad2=msts(fin$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
#finLoad_test1=tail(finLoad,24*7)
#finLoad_train1=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25*6)

#1year
#finLoad2=msts(fin$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
#finLoad_test1=tail(finLoad,24*7)
#finLoad_train1=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25*12)

finLoad=ts(fin$ActualTotalLoad,frequency = 24)

finLoad1=na_ma(finLoad1)
finLoad2=na_ma(finLoad2)
finLoad=na_ma(finLoad)
```


```{r}
out=tsoutliers(finLoad1)

for (o in out$index){
  finLoad1[o]=NA
}

out=tsoutliers(finLoad2)

for (o in out$index){
  finLoad2[o]=NA
}

out=tsoutliers(finLoad)

for (o in out$index){
  finLoad[o]=NA
}

```

```{r}
skimr::skim(finLoad1)
finLoad1=na_ma(finLoad1)
finLoad2=na_ma(finLoad2)
finLoad=na_ma(finLoad)
```

2week

```{r}
finLoad_test1=tail(finLoad1,24*7)
finLoad_train1=tail(head(finLoad1,length(finLoad1)-24*7),24*7*2+1)
finLoad_train1 %>%
  mstl() %>% 
  autoplot()
```

1month

```{r}
finLoad_train2=tail(head(finLoad1,length(finLoad1)-24*7),24*7*4.25)
finLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

3month

```{r}
finLoad_test2=tail(finLoad2,24*7)
finLoad_train3=tail(head(finLoad2,length(finLoad2)-24*7),24*7*4.25*3)
finLoad_train3 %>%
  mstl() %>% 
  autoplot()
```

6month

```{r}
finLoad_train4=tail(head(finLoad2,length(finLoad2)-24*7),24*7*4.25*6)
finLoad_train4 %>%
  mstl() %>% 
  autoplot()
```

1year

```{r}
finLoad_train5=tail(head(finLoad2,length(finLoad2)-24*7),24*7*4.25*12)
finLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## Snaive model

```{r}
fin.sna=snaive(finLoad_train1,h=24*7)
```

```{r}
autoplot(fin.sna$mean,color='blue')+
  autolayer(finLoad_test1, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none") +
  labs(x="Next week hourly forecast",y="Electricity load")
```

## stlm() model

### Overview of the models

```{r}
fin.stlm1=finLoad_train1 %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)
```

```{r}
autoplot(fin.stlm1$mean,color='blue')+
  autolayer(finLoad_test1, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```

```{r}
fin.stlm2=finLoad_train2 %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)
```

```{r}
autoplot(fin.stlm2$mean,color='blue')+
  autolayer(finLoad_test1, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```

```{r}
fin.stlm3=finLoad_train3 %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)
```

```{r}
autoplot(fin.stlm3$mean,color='blue')+
  autolayer(finLoad_test2, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```

```{r}
fin.stlm4=finLoad_train4 %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)
```

```{r}
autoplot(fin.stlm4$mean,color='blue')+
  autolayer(finLoad_test2, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```

```{r}
fin.stlm5=finLoad_train5 %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)
```

```{r}
autoplot(fin.stlm5$mean,color='blue')+
  autolayer(finLoad_test2, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```



```{r}
rbind(accuracy(as.vector(fin.stlm1$mean),finLoad_test1),
      accuracy(as.vector(fin.stlm2$mean),finLoad_test1),
      accuracy(as.vector(fin.stlm3$mean),finLoad_test2),
      accuracy(as.vector(fin.stlm4$mean),finLoad_test2),
      accuracy(as.vector(fin.stlm5$mean),finLoad_test2))
```


### Cross-valication

we will test forecasts for 52 weeks(around 1 year).

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  finLoad_test1=head(tail(finLoad1,24*7*i),24*7) #2week,1month
  finLoad_test2=head(tail(finLoad2,24*7*i),24*7) #3month,6month,1year
  
  finLoad_train1=tail(head(finLoad1,length(finLoad1)-24*7*i),24*7*2+1) #2week
  finLoad_train2=tail(head(finLoad1,length(finLoad1)-24*7*i),24*7*4.25) #1month
  finLoad_train3=tail(head(finLoad2,length(finLoad2)-24*7*i),24*7*4.25*3) #3month
  finLoad_train4=tail(head(finLoad2,length(finLoad2)-24*7*i),24*7*4.25*6) #6month
  finLoad_train5=tail(head(finLoad2,length(finLoad2)-24*7*i),24*7*4.25*12) #1year
  
  fin.stlm1=finLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fin.stlm2=finLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fin.stlm3=finLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fin.stlm4=finLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fin.stlm5=finLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fin.sna1=snaive(finLoad_train1,h=24*7)
  fin.sna2=snaive(finLoad_train2,h=24*7)
  fin.sna3=snaive(finLoad_train3,h=24*7)
  fin.sna4=snaive(finLoad_train4,h=24*7)
  fin.sna5=snaive(finLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fin.stlm1$mean,finLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(fin.stlm2$mean,finLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(fin.stlm3$mean,finLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(fin.stlm4$mean,finLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(fin.stlm5$mean,finLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fin.stlm1$mean,finLoad_test1)[3]/accuracy(fin.sna1$mean,finLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fin.stlm2$mean,finLoad_test1)[3]/accuracy(fin.sna2$mean,finLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fin.stlm3$mean,finLoad_test2)[3]/accuracy(fin.sna3$mean,finLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fin.stlm4$mean,finLoad_test2)[3]/accuracy(fin.sna4$mean,finLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fin.stlm5$mean,finLoad_test2)[3]/accuracy(fin.sna5$mean,finLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(finLoad_test1-fin.stlm1$mean)/(finLoad_test1+fin.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(finLoad_test1-fin.stlm2$mean)/(finLoad_test1+fin.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(finLoad_test2-fin.stlm3$mean)/(finLoad_test2+fin.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(finLoad_test2-fin.stlm4$mean)/(finLoad_test2+fin.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(finLoad_test2-fin.stlm5$mean)/(finLoad_test2+fin.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

according to sMAPE, 1-month time window is the best for the train data.

performance of last 4 weeks:

```{r}
colMeans(MAEs[1:4,])
colMeans(sMAPEs[1:4,])
```

performance of last 8 weeks:

```{r}
colMeans(MAEs[1:8,])
colMeans(sMAPEs[1:8,])
```

performance of last 16 weeks:

```{r}
colMeans(MAEs[1:16,])
colMeans(sMAPEs[1:16,])
```

performance of last 32 weeks:

```{r}
colMeans(MAEs[1:32,])
colMeans(sMAPEs[1:32,])
```

we can hardly tell that which time window is the best between 6-month and 1-year.

# ETS

```{r}
finLoad_teste=tail(finLoad,24*7)
finLoad_traine1=tail(head(finLoad,length(finLoad)-24*7),24*7*2+1)
finLoad_traine2=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)
finLoad_traine3=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25*3)
```

```{r}
fin.ets1=ets(finLoad_traine2,lambda = 0)
fc1=forecast(fin.ets1,h=24*7)$mean
```

```{r}
autoplot(fc1,color='blue')+
  autolayer(finLoad_teste, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  finLoad_test=head(tail(finLoad,24*7*i),24*7)
  
  finLoad_train1=tail(head(finLoad,length(finLoad)-24*7*i),24*7*2+1)
  finLoad_train2=tail(head(finLoad,length(finLoad)-24*7*i),24*7*4.25)
  finLoad_train3=tail(head(finLoad,length(finLoad)-24*7*i),24*7*4.25*3)
  finLoad_train4=tail(head(finLoad,length(finLoad)-24*7*i),24*7*4.25*6)
  finLoad_train5=tail(head(finLoad,length(finLoad)-24*7*i),24*7*4.25*12)
  
  fin.ets1=ets(finLoad_train1,lambda = 0)
  fc1=forecast(fin.ets1,h=24*7)$mean
  
  fin.ets2=ets(finLoad_train2,lambda = 0)
  fc2=forecast(fin.ets2,h=24*7)$mean
  
  fin.ets3=ets(finLoad_train3,lambda = 0)
  fc3=forecast(fin.ets3,h=24*7)$mean
  
  fin.ets4=ets(finLoad_train4,lambda = 0)
  fc4=forecast(fin.ets4,h=24*7)$mean
  
  fin.ets5=ets(finLoad_train5,lambda = 0)
  fc5=forecast(fin.ets5,h=24*7)$mean
  
  
  fin.sna=snaive(finLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,finLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,finLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,finLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,finLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,finLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(finLoad_test-fc1)/(finLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(finLoad_test-fc2)/(finLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(finLoad_test-fc3)/(finLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(finLoad_test-fc4)/(finLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(finLoad_test-fc5)/(finLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
finweather=read_csv("fin_weather.csv")
finweather$TimeUTC=dmy_hm(finweather$TimeUTC)
finweather$T=as.double(finweather$T)
fin=left_join(fin,finweather,by="TimeUTC")

finholiday=read_csv("fin_holiday.csv")
finholiday$TimeUTC=dmy_hm(finholiday$TimeUTC)
finholiday$Holiday=as.integer(finholiday$Holiday)
fin=left_join(fin,finholiday,by="TimeUTC")
```

```{r}
finTem=ts(fin$T,frequency=24)
finTem=na_ma(finTem)
finHoli=ts(fin$Holiday,frequency=24)
finHoli=na_ma(finHoli)
```

## Prophet

需要按照各个国家自己的时区的时间来导出数据才能将节日包括进去
Their own time zone!!!!

```{r}
m=prophet(holidays=NULL)
finholi=add_country_holidays(m,country_name = 'FI')
```

```{r}
colnames(fin)=c('ds','y')
m=fit.prophet(finholi,fin) #超过了历史数据个数限制，用不了
m$train.holiday.names
```

```{r}
future=make_future_dataframe(m,periods=168,freq=3600)
future
```

```{r}
forecast=predict(m,future)
```

```{r}
forecast
```


## TBATS

short-term train data can be tested by this model

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  finLoad_test1=head(tail(finLoad1,24*7*i),24*7) #2week,1month
  
  finLoad_train1=tail(head(finLoad1,length(finLoad1)-24*7*i),24*7*2+1) #2week
  finLoad_train2=tail(head(finLoad1,length(finLoad1)-24*7*i),24*7*4.25) #1month
  
  
  fin.tbats1=finLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fin.tbats.fore1=forecast(fin.tbats1,h=24*7)
  
  fin.tbats2=finLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fin.tbats.fore2=forecast(fin.tbats2,h=24*7)
  
  
  fin.sna1=snaive(finLoad_train1,h=24*7)
  fin.sna2=snaive(finLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(fin.tbats.fore1$mean,finLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(fin.tbats.fore2$mean,finLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(fin.tbats.fore1$mean,finLoad_test1)[3]/accuracy(fin.sna1$mean,finLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fin.tbats.fore2$mean,finLoad_test1)[3]/accuracy(fin.sna2$mean,finLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(finLoad_test1-fin.tbats.fore1$mean)/(finLoad_test1+fin.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(finLoad_test1-fin.tbats.fore2$mean)/(finLoad_test1+fin.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

```{r}
fin.tbats=finLoad_train2 %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
fin.tbats.fore=forecast(fin.tbats,h=24*7)
```

```{r}
autoplot(fin.tbats.fore$mean,color='blue')+
  autolayer(finLoad_test1, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")
```


TBATS model performs worse than stlm model.

## Regression with ARIMA errors

可以加入温度（来自天气预报）、节日、工作日、工作时间等的数据。先用dummy variables加在fin的表里，再用ts。
Temperature, Festival, Workday

## Dynamic harmonic regression

```{r}
finLoad=ts(fin$ActualTotalLoad,frequency = 24*365.25)
finLoad_test=tail(finLoad,24*7)
finLoad_train=head(finLoad,length(finLoad)-24*7)
```


```{r}
plots <- list()
for (i in seq(6)) {
  fit <- auto.arima(finLoad_train, xreg = fourier(finLoad_train, K = i), lambda = 0)
  plots[[i]] <- autoplot(forecast(fit,xreg=fourier(finLoad_train, K=i, h=24*7))) +
    xlab(paste("K=",i,"   AICC=",round(fit$aicc,2))) + 
    ylab("") + ylim(1.5,4.7) 
}

gridExtra::grid.arrange(plots[[1]],plots[[2]],plots[[3]],
                        plots[[4]],plots[[5]],plots[[6]], nrow=3)
```


```{r}
finLoad_train1=tail(head(finLoad,length(finLoad)-24*7),24*7*4)
```


```{r}
plots <- list()
for (i in seq(6)) {
  fit <- auto.arima(finLoad_train1, xreg = fourier(finLoad_train1, K = i),seasonal = F, lambda = 0)
  plots[[i]] <- autoplot(forecast(fit,xreg=fourier(finLoad_train1, K=i, h=24*7))) +
    xlab(paste("K=",i,"   AICC=",round(fit$aicc,2))) + 
    ylab("") + ylim(1.5,4.7) 
}

gridExtra::grid.arrange(plots[[1]],plots[[2]],plots[[3]],
                        plots[[4]],plots[[5]],plots[[6]], nrow=3)
```

## Forecasting with temporal aggregation

```{r}
colnames(fin)=c("TimeUTC","ActualTotalLoad")
finLoad=ts(fin$ActualTotalLoad,frequency = 24)
finLoad=na_ma(finLoad)
finLoad_test=tail(finLoad,24*7)
finLoad_train=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)
```

```{r}
fin.mapa=mapa(finLoad_train,minimumAL=1,maximumAL=3,comb="w.mean",type="es",fh=168)
```

```{r}
fin.mapa=mapaest(finLoad_train,paral=2)
```

```{r}
fin.mapa.for=mapafor(finLoad_train,fin.mapa,fh=168,outplot=1)
```

## Forecast combination

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,4))
RelMAEs=array(NA,c(15,4))
sMAPEs=array(NA,c(15,4))
sMAPEs1=array(NA,c(15,4))
sMAPEs2=array(NA,c(15,4))
sMAPEs3=array(NA,c(15,4))

for (i in 2:16){
  print(i)
  finLoad_test=head(tail(finLoad,24*7*i),24*7) #1month
  finLoad_test=as.vector(finLoad_test)
  
  finLoad_train1=tail(head(finLoad1,length(finLoad1)-24*7*i),24*7*4.25) #1month
  
  finLoad_train2=tail(head(finLoad,length(finLoad)-24*7*i),24*7*4.25)
  
  fin.stlm=finLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(fin.stlm$mean)
  
  fin.tbats=finLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(fin.tbats,h=24*7)$mean)
  
  fin.ets=ets(finLoad_train2,lambda = 0)
  fc3=as.vector(forecast(fin.ets,h=24*7)$mean)
  
  fin.mapa=mapaest(finLoad_train2,paral=2)
  fin.mapa.for=mapafor(finLoad_train2,fin.mapa,fh=24*7,outplot=0)
  fc4=as.vector(fin.mapa.for$outfor)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  #from previous rounds' forecasts, we notice that for Finland, the forecasts of all methods will underestimate the 3-7 days in the week, we can also notice that tbats is the method that most close to the truth
  fore_comb2=0.2*fc1+0.4*fc2+0.2*fc3+0.2*fc4
  fore_comb3=append(append(fore_comb1[1:48],fore_comb1[49:96]*1.2),fore_comb1[97:168]*1.5)
  fore_comb4=append(append(fore_comb2[1:48],fore_comb2[49:96]*1.2),fore_comb2[97:168]*1.5)
  
   fin.sna=snaive(finLoad_train2,h=24*7)

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,finLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,finLoad_test)[3]
   MAEs[which(i==2:16),3]=accuracy(fore_comb3,finLoad_test)[3]
   MAEs[which(i==2:16),4]=accuracy(fore_comb4,finLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
   RelMAEs[which(i==2:16),3]=accuracy(fore_comb3,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
   RelMAEs[which(i==2:16),4]=accuracy(fore_comb4,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(finLoad_test-fore_comb1)/(finLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(finLoad_test-fore_comb2)/(finLoad_test+fore_comb2)))
  sMAPEs[which(i==2:16),3]=mean(200*(abs(finLoad_test-fore_comb3)/(finLoad_test+fore_comb3)))
  sMAPEs[which(i==2:16),4]=mean(200*(abs(finLoad_test-fore_comb4)/(finLoad_test+fore_comb4)))
  
  sMAPEs1[which(i==2:16),1]=mean(200*(finLoad_test[1:48]-fore_comb1[1:48]/(finLoad_test[1:48]+fore_comb1[1:48])))
  sMAPEs1[which(i==2:16),2]=mean(200*(finLoad_test[1:48]-fore_comb2[1:48]/(finLoad_test[1:48]+fore_comb2[1:48])))
  sMAPEs1[which(i==2:16),3]=mean(200*(finLoad_test[1:48]-fore_comb3[1:48]/(finLoad_test[1:48]+fore_comb3[1:48])))
  sMAPEs1[which(i==2:16),4]=mean(200*(finLoad_test[1:48]-fore_comb4[1:48]/(finLoad_test[1:48]+fore_comb4[1:48])))
  
  sMAPEs2[which(i==2:16),1]=mean(200*(finLoad_test[49:96]-fore_comb1[49:96]/(finLoad_test[49:96]+fore_comb1[49:96])))
  sMAPEs2[which(i==2:16),2]=mean(200*(finLoad_test[49:96]-fore_comb2[49:96]/(finLoad_test[49:96]+fore_comb2[49:96])))
  sMAPEs2[which(i==2:16),3]=mean(200*(finLoad_test[49:96]-fore_comb3[49:96]/(finLoad_test[49:96]+fore_comb3[49:96])))
  sMAPEs2[which(i==2:16),4]=mean(200*(finLoad_test[49:96]-fore_comb4[49:96]/(finLoad_test[49:96]+fore_comb4[49:96])))
  
  sMAPEs3[which(i==2:16),1]=mean(200*(finLoad_test[97:168]-fore_comb1[97:168]/(finLoad_test[97:168]+fore_comb1[97:168])))
  sMAPEs3[which(i==2:16),2]=mean(200*(finLoad_test[97:168]-fore_comb2[97:168]/(finLoad_test[97:168]+fore_comb2[97:168])))
  sMAPEs3[which(i==2:16),3]=mean(200*(finLoad_test[97:168]-fore_comb3[97:168]/(finLoad_test[97:168]+fore_comb3[97:168])))
  sMAPEs3[which(i==2:16),4]=mean(200*(finLoad_test[97:168]-fore_comb4[97:168]/(finLoad_test[97:168]+fore_comb4[97:168])))

}

fin.comb.maes=colMeans(MAEs,na.rm=T)
fin.comb.relmaes=colMeans(RelMAEs,na.rm=T)
fin.comb.smapes=colMeans(sMAPEs,na.rm=T)
fin.comb.smapes1=colMeans(sMAPEs1,na.rm=T)
fin.comb.smapes2=colMeans(sMAPEs2,na.rm=T)
fin.comb.smapes3=colMeans(sMAPEs3,na.rm=T)
```

```{r}
fin.comb.maes
fin.comb.relmaes
fin.comb.smapes
fin.comb.smapes1
fin.comb.smapes2
fin.comb.smapes3
```


## Final Forecast

### Round 1

```{r}
fin.train.stlm=tail(head(finLoad1,length(finLoad1)-24*7),24*7*4.25)
finLoad_test=tail(finLoad,24*7)

fin.stlm=fin.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

fin.fc1=as.vector(fin.stlm$mean)
```

```{r}
finLoad_train=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)
finHoli_train=tail(head(finHoli,length(finHoli)-24*7),24*7*4.25)
finHoli_test=tail(finHoli,24*7)
```

```{r}
fin.rarima=auto.arima(finLoad_train,xreg=finHoli_train)
fin.rarima.for=forecast(fin.rarima,xreg=finHoli_test)
fin.fc2=as.vector(fin.rarima.for$mean)
```

```{r}
autoplot(fin.rarima.for$mean,color='blue')+
  autolayer(finLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
fin.fore.comb=(fin.fc1+fin.fc2)/2
```

```{r, warning=FALSE}
finLoad_test=tail(finLoad,24*7)
finLoad_test=as.vector(finLoad_test)

fore=tibble(ID=1:168,fc1=fin.fc1,fc2=fin.fc2,Comb=fin.fore.comb,Actual=finLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
fin.fore.comb=ts(fin.fore.comb,frequency = 24)
finLoad_test=ts(finLoad_test,frequency = 24)

autoplot(fin.fore.comb,color='blue')+
  autolayer(finLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
fin.sna=snaive(finLoad_test,h=24*7)

MAE=accuracy(fin.fore.comb,finLoad_test)[3]
  
RelMAE=accuracy(fin.fore.comb,finLoad_test)[3]/accuracy(as.vector(fin.sna$mean),as.vector(finLoad_test))[3]

sMAPE=mean(200*(abs(finLoad_test-fin.fore.comb)/(finLoad_test+fin.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# fin.train.stlm=tail(head(finLoad1,length(finLoad1)-24*7),24*7*4.25)
# 
# fin.stlm=fin.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# fin.fc1=as.vector(fin.stlm$mean)
```

```{r}
finLoad_train=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)
finTem_train=tail(head(finTem,length(finTem)-24*7),24*7*4.25)
finTem_test=tail(finTem,24*7)
```

```{r}
fin.rarima=auto.arima(finLoad_train,xreg=finTem_train)
fin.rarima.for=forecast(fin.rarima,xreg=finTem_test)
fin.fc3=as.vector(fin.rarima.for$mean)
```

```{r}
fin.tbats.train=tail(head(finLoad1,length(finLoad1)-24*7),24*7*4.25)
fin.tbats=fin.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
fin.tbats.fore=forecast(fin.tbats,h=24*7)
fin.fc4=as.vector(fin.tbats.fore$mean)
```

```{r}
fin.ets.train=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)
fin.ets=ets(fin.ets.train,lambda = 0)
fin.fc5=as.vector(forecast(fin.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=fin.fc1,fc2=fin.fc4,fc3=fin.fc2,fc4=fin.fc3,fc5=fin.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#fin.fore.comb=rowMeans(fore)

fin.fore.comb=vector()

for (i in 1:168){
  fin.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
finLoad_test=tail(finLoad,24*7)
finLoad_test=as.vector(finLoad_test)

fore=tibble(ID=1:168,fc1=fin.fc1,fc2=fin.fc4,fc3=fin.fc2,fc4=fin.fc3,fc5=fin.fc5,Comb=fin.fore.comb,Actual=finLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
fin.fore.comb=ts(fin.fore.comb,frequency = 24)
finLoad_test=ts(finLoad_test,frequency = 24)

autoplot(fin.fore.comb,color='blue')+
  autolayer(finLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
fin.sna=snaive(finLoad_test,h=24*7)

MAE=accuracy(fin.fore.comb,finLoad_test)[3]
  
RelMAE=accuracy(fin.fore.comb,finLoad_test)[3]/accuracy(as.vector(fin.sna$mean),as.vector(finLoad_test))[3]

sMAPE=mean(200*(abs(finLoad_test-fin.fore.comb)/(finLoad_test+fin.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,4))
RelMAEs=array(NA,c(15,4))
sMAPEs=array(NA,c(15,4))

for (i in 2:16){
  print(i)
  finLoad_test=head(tail(finLoad,24*7*i),24*7) #1month
  finLoad_test=as.vector(finLoad_test)
  
  finLoad_train1=tail(head(finLoad1,length(finLoad1)-24*7*i),24*7*4.25) #1month
  
  finLoad_train2=tail(head(finLoad,length(finLoad)-24*7*i),24*7*4.25)
  
  fin.stlm=finLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(fin.stlm$mean)
  
  fin.tbats=finLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(fin.tbats,h=24*7)$mean)
  
  fin.ets=ets(finLoad_train2,lambda = 0)
  fc3=as.vector(forecast(fin.ets,h=24*7)$mean)
  
  fin.mapa=mapaest(finLoad_train2,paral=2)
  fin.mapa.for=mapafor(finLoad_train2,fin.mapa,fh=24*7,outplot=0)
  fc4=as.vector(fin.mapa.for$outfor)
  
  fin.sna=snaive(finLoad_train2,h=24*7)
  fc5=as.vector(fin.sna$mean)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4
  fore_comb3=(fc1+fc2+fc3+fc4+fc5)/5
  fore_comb4=0.15*fc1+0.15*fc2+0.15*fc3+0.15*fc4+0.4*fc5

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,finLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,finLoad_test)[3]
   MAEs[which(i==2:16),3]=accuracy(fore_comb3,finLoad_test)[3]
   MAEs[which(i==2:16),4]=accuracy(fore_comb4,finLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
   RelMAEs[which(i==2:16),3]=accuracy(fore_comb3,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]
   RelMAEs[which(i==2:16),4]=accuracy(fore_comb4,finLoad_test)[3]/accuracy(fin.sna$mean,finLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(finLoad_test-fore_comb1)/(finLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(finLoad_test-fore_comb2)/(finLoad_test+fore_comb2)))
  sMAPEs[which(i==2:16),3]=mean(200*(abs(finLoad_test-fore_comb3)/(finLoad_test+fore_comb3)))
  sMAPEs[which(i==2:16),4]=mean(200*(abs(finLoad_test-fore_comb4)/(finLoad_test+fore_comb4)))

}

fin.comb.maes=colMeans(MAEs,na.rm=T)
fin.comb.relmaes=colMeans(RelMAEs,na.rm=T)
fin.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
fin.comb.maes
fin.comb.relmaes
fin.comb.smapes
```

```{r}
fin.train.mapa=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25)
fin.mapa=mapaest(fin.train.mapa,paral=2)

fin.mapa.for=mapafor(fin.train.mapa,fin.mapa,fh=24*7,outplot=1)
fin.fc6=fin.mapa.for$outfor
```

```{r}
finLoad_test=ts(as.vector(tail(finLoad,24*7)),frequency = 24)

autoplot(ts(fin.fc6,frequency = 24),color='blue')+
  autolayer(finLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
fin.fore.comb=0.4*fin.fc1+0.2*fin.fc4+0.2*fin.fc5+0.2*fin.fc6
```

```{r, warning=FALSE}
finLoad_test=tail(finLoad,24*7)
finLoad_test=as.vector(finLoad_test)

fore=tibble(ID=1:168,fc1=fin.fc1,fc2=fin.fc4,fc3=fin.fc5,fc4=fin.fc6,Comb=fin.fore.comb,Actual=finLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
fin.fore.comb=ts(fin.fore.comb,frequency = 24)
finLoad_test=ts(finLoad_test,frequency = 24)

autoplot(fin.fore.comb,color='blue')+
  autolayer(finLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
fin.sna=snaive(finLoad_test,h=24*7)

MAE=accuracy(fin.fore.comb,finLoad_test)[3]
  
RelMAE=accuracy(fin.fore.comb,finLoad_test)[3]/accuracy(as.vector(fin.sna$mean),as.vector(finLoad_test))[3]

sMAPE=mean(200*(abs(finLoad_test-fin.fore.comb)/(finLoad_test+fin.fore.comb)))

MAE
RelMAE
sMAPE
```

```{r}
write_csv(as_tibble(fin.stlm$mean),file='fin_forecast.csv')
```

```{r}
write_csv(as_tibble(fin.tbats.fore$mean),file='fin_forecast.csv',append = T)
```

```{r}
write_csv(as_tibble(fin.mapa.for$outfor),file='fin_forecast.csv',append = T)
```

## Round 4

```{r}
all_weekday=read_csv("weekday.csv")
all_weekday$TimeUTC=dmy_hm(all_weekday$TimeUTC)
all_weekday$Weekday=as.integer(all_weekday$Weekday)

all_week=ts(all_weekday$Weekday,frequency = 24)
```

```{r}
finLoad_train=tail(head(finLoad,length(finLoad)-24*7),24*7*4.25*12)
finLoad_test=tail(finLoad,24*7)
finWeek_train=tail(head(all_week,length(all_week)-24*7),24*7*4.25*12)
finWeek_test=tail(all_week,24*7)
```

```{r}
fin.rarima=auto.arima(finLoad_train,xreg=finWeek_train)
fin.rarima.for=forecast(fin.rarima,xreg=finWeek_test)
fin.fc7=as.vector(fin.rarima.for$mean)
```

```{r}
autoplot(fin.rarima.for$mean,color='blue')+
  autolayer(finLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

still not well.

# France

## Decomposition

```{r}
fraLoad1=msts(fra$ActualTotalLoad,seasonal.periods = c(24,24*7))
fraLoad1=na_ma(fraLoad1)
fraLoad2=msts(fra$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
fraLoad2=na_ma(fraLoad2)

fraLoad=ts(fra$ActualTotalLoad,frequency = 24)
fraLoad=na_ma(fraLoad)
```

```{r}
length(as.vector(tsoutliers(fraLoad)$index))/length(fraLoad)
```

```{r}
out=tsoutliers(fraLoad1)

for (o in out$index){
  fraLoad1[o]=NA
}

out=tsoutliers(fraLoad2)

for (o in out$index){
  fraLoad2[o]=NA
}

out=tsoutliers(fraLoad)

for (o in out$index){
  fraLoad[o]=NA
}

```

```{r}
skimr::skim(fraLoad1)
fraLoad1=na_ma(fraLoad1)
fraLoad2=na_ma(fraLoad2)
fraLoad=na_ma(fraLoad)
```



```{r}
fraLoad_train2=tail(head(fraLoad1,length(fraLoad1)-24*7),24*7*4.25) #1month

fraLoad_train5=tail(head(fraLoad2,length(fraLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r}
fraLoad_train2=tail(head(fraLoad1,length(fraLoad1)-24*7),24*7*4.25)
fraLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
fraLoad_train5=tail(head(fraLoad2,length(fraLoad2)-24*7),24*7*4.25*12)
fraLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```


## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  fraLoad_test1=head(tail(fraLoad1,24*7*i),24*7) #2week,1month
  fraLoad_test2=head(tail(fraLoad2,24*7*i),24*7) #3month,6month,1year
  
  fraLoad_train1=tail(head(fraLoad1,length(fraLoad1)-24*7*i),24*7*2+1) #2week
  fraLoad_train2=tail(head(fraLoad1,length(fraLoad1)-24*7*i),24*7*4.25) #1month
  fraLoad_train3=tail(head(fraLoad2,length(fraLoad2)-24*7*i),24*7*4.25*3) #3month
  fraLoad_train4=tail(head(fraLoad2,length(fraLoad2)-24*7*i),24*7*4.25*6) #6month
  fraLoad_train5=tail(head(fraLoad2,length(fraLoad2)-24*7*i),24*7*4.25*12) #1year
  
  fra.stlm1=fraLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fra.stlm2=fraLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fra.stlm3=fraLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fra.stlm4=fraLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fra.stlm5=fraLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fra.sna1=snaive(fraLoad_train1,h=24*7)
  fra.sna2=snaive(fraLoad_train2,h=24*7)
  fra.sna3=snaive(fraLoad_train3,h=24*7)
  fra.sna4=snaive(fraLoad_train4,h=24*7)
  fra.sna5=snaive(fraLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fra.stlm1$mean,fraLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(fra.stlm2$mean,fraLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(fra.stlm3$mean,fraLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(fra.stlm4$mean,fraLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(fra.stlm5$mean,fraLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fra.stlm1$mean,fraLoad_test1)[3]/accuracy(fra.sna1$mean,fraLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fra.stlm2$mean,fraLoad_test1)[3]/accuracy(fra.sna2$mean,fraLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fra.stlm3$mean,fraLoad_test2)[3]/accuracy(fra.sna3$mean,fraLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fra.stlm4$mean,fraLoad_test2)[3]/accuracy(fra.sna4$mean,fraLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fra.stlm5$mean,fraLoad_test2)[3]/accuracy(fra.sna5$mean,fraLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(fraLoad_test1-fra.stlm1$mean)/(fraLoad_test1+fra.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(fraLoad_test1-fra.stlm2$mean)/(fraLoad_test1+fra.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(fraLoad_test2-fra.stlm3$mean)/(fraLoad_test2+fra.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(fraLoad_test2-fra.stlm4$mean)/(fraLoad_test2+fra.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(fraLoad_test2-fra.stlm5$mean)/(fraLoad_test2+fra.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  fraLoad_test1=head(tail(fraLoad1,24*7*i),24*7) #2week,1month
  
  fraLoad_train1=tail(head(fraLoad1,length(fraLoad1)-24*7*i),24*7*2+1) #2week
  fraLoad_train2=tail(head(fraLoad1,length(fraLoad1)-24*7*i),24*7*4.25) #1month
  
  
  fra.tbats1=fraLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fra.tbats.fore1=forecast(fra.tbats1,h=24*7)
  
  fra.tbats2=fraLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fra.tbats.fore2=forecast(fra.tbats2,h=24*7)
  
  
  fra.sna1=snaive(fraLoad_train1,h=24*7)
  fra.sna2=snaive(fraLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(fra.tbats.fore1$mean,fraLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(fra.tbats.fore2$mean,fraLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(fra.tbats.fore1$mean,fraLoad_test1)[3]/accuracy(fra.sna1$mean,fraLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fra.tbats.fore2$mean,fraLoad_test1)[3]/accuracy(fra.sna2$mean,fraLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(fraLoad_test1-fra.tbats.fore1$mean)/(fraLoad_test1+fra.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(fraLoad_test1-fra.tbats.fore2$mean)/(fraLoad_test1+fra.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  fraLoad_test=head(tail(fraLoad,24*7*i),24*7)
  fraLoad_train1=tail(head(fraLoad,length(fraLoad)-24*7*i),24*7*2+1)
  fraLoad_train2=tail(head(fraLoad,length(fraLoad)-24*7*i),24*7*4.25)
  fraLoad_train3=tail(head(fraLoad,length(fraLoad)-24*7*i),24*7*4.25*3)
  fraLoad_train4=tail(head(fraLoad,length(fraLoad)-24*7*i),24*7*4.25*6)
  fraLoad_train5=tail(head(fraLoad,length(fraLoad)-24*7*i),24*7*4.25*12)
  
  fra.ets1=ets(fraLoad_train1,lambda = 0)
  fc1=forecast(fra.ets1,h=24*7)$mean
  
  fra.ets2=ets(fraLoad_train2,lambda = 0)
  fc2=forecast(fra.ets2,h=24*7)$mean
  
  fra.ets3=ets(fraLoad_train3,lambda = 0)
  fc3=forecast(fra.ets3,h=24*7)$mean
  
  fra.ets4=ets(fraLoad_train4,lambda = 0)
  fc4=forecast(fra.ets4,h=24*7)$mean
  
  fra.ets5=ets(fraLoad_train5,lambda = 0)
  fc5=forecast(fra.ets5,h=24*7)$mean
  
  
  fra.sna=snaive(fraLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,fraLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,fraLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,fraLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,fraLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,fraLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(fraLoad_test-fc1)/(fraLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(fraLoad_test-fc2)/(fraLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(fraLoad_test-fc3)/(fraLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(fraLoad_test-fc4)/(fraLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(fraLoad_test-fc5)/(fraLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
fraweather=read_csv("fra_weather.csv")
fraweather$TimeUTC=dmy_hm(fraweather$TimeUTC)
fraweather$T=as.double(fraweather$T)
fra=left_join(fra,fraweather,by="TimeUTC")

fraholiday=read_csv("fra_holiday.csv")
fraholiday$TimeUTC=dmy_hm(fraholiday$TimeUTC)
fraholiday$Holiday=as.integer(fraholiday$Holiday)
fra=left_join(fra,fraholiday,by="TimeUTC")
```

```{r}
fraTem=ts(fra$T,frequency=24)
fraTem=na_ma(fraTem)
fraHoli=ts(fra$Holiday,frequency=24)
```

## Final Forecast

### Round 1

```{r}
fra.train.stlm=tail(head(fraLoad1,length(fraLoad1)-24*7),24*7*4.25)
fraLoad_test=tail(fraLoad,24*7)

fra.stlm=fra.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

fra.fc1=as.vector(fra.stlm$mean)
```

```{r}
fraLoad_train=tail(head(fraLoad,length(fraLoad)-24*7),24*7*4.25)
fraHoli_train=tail(head(fraHoli,length(fraHoli)-24*7),24*7*4.25)
fraHoli_test=tail(fraHoli,24*7)
```

```{r}
fra.rarima=auto.arima(fraLoad_train,xreg=fraHoli_train)
fra.rarima.for=forecast(fra.rarima,xreg=fraHoli_test)
fra.fc2=as.vector(fra.rarima.for$mean)
```

```{r}
autoplot(fra.rarima.for$mean,color='blue')+
  autolayer(fraLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
fra.fore.comb=(fra.fc1+fra.fc2)/2
```

```{r, warning=FALSE}
fraLoad_test=tail(fraLoad,24*7)
fraLoad_test=as.vector(fraLoad_test)

fore=tibble(ID=1:168,fc1=fra.fc1,fc2=fra.fc2,Comb=fra.fore.comb,Actual=fraLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
fra.fore.comb=ts(fra.fore.comb,frequency = 24)
fraLoad_test=ts(fraLoad_test,frequency = 24)

autoplot(fra.fore.comb,color='blue')+
  autolayer(fraLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
fra.sna=snaive(fraLoad_test,h=24*7)

MAE=accuracy(fra.fore.comb,fraLoad_test)[3]
  
RelMAE=accuracy(fra.fore.comb,fraLoad_test)[3]/accuracy(as.vector(fra.sna$mean),as.vector(fraLoad_test))[3]

sMAPE=mean(200*(abs(fraLoad_test-fra.fore.comb)/(fraLoad_test+fra.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# fra.train.stlm=tail(head(fraLoad1,length(fraLoad1)-24*7),24*7*4.25)
# 
# fra.stlm=fra.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# fra.fc1=as.vector(fra.stlm$mean)
```

```{r}
fraLoad_train=tail(head(fraLoad,length(fraLoad)-24*7),24*7*4.25)
fraTem_train=tail(head(fraTem,length(fraTem)-24*7),24*7*4.25)
fraTem_test=tail(fraTem,24*7)
```

```{r}
fra.rarima=auto.arima(fraLoad_train,xreg=fraTem_train)
fra.rarima.for=forecast(fra.rarima,xreg=fraTem_test)
fra.fc3=as.vector(fra.rarima.for$mean)
```

```{r}
fra.tbats.train=tail(head(fraLoad1,length(fraLoad1)-24*7),24*7*4.25)
fra.tbats=fra.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
fra.tbats.fore=forecast(fra.tbats,h=24*7)
fra.fc4=as.vector(fra.tbats.fore$mean)
```

```{r}
fra.ets.train=tail(head(fraLoad,length(fraLoad)-24*7),24*7*4.25)
fra.ets=ets(fra.ets.train,lambda = 0)
fra.fc5=as.vector(forecast(fra.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=fra.fc1,fc2=fra.fc4,fc3=fra.fc2,fc4=fra.fc3,fc5=fra.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#fra.fore.comb=rowMeans(fore)

fra.fore.comb=vector()

for (i in 1:168){
  fra.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
fraLoad_test=tail(fraLoad,24*7)
fraLoad_test=as.vector(fraLoad_test)

fore=tibble(ID=1:168,fc1=fra.fc1,fc2=fra.fc4,fc3=fra.fc2,fc4=fra.fc3,fc5=fra.fc5,Comb=fra.fore.comb,Actual=fraLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
fra.fore.comb=ts(fra.fore.comb,frequency = 24)
fraLoad_test=ts(fraLoad_test,frequency = 24)

autoplot(fra.fore.comb,color='blue')+
  autolayer(fraLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
fra.sna=snaive(fraLoad_test,h=24*7)

MAE=accuracy(fra.fore.comb,fraLoad_test)[3]
  
RelMAE=accuracy(fra.fore.comb,fraLoad_test)[3]/accuracy(as.vector(fra.sna$mean),as.vector(fraLoad_test))[3]

sMAPE=mean(200*(abs(fraLoad_test-fra.fore.comb)/(fraLoad_test+fra.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  fraLoad_test=head(tail(fraLoad,24*7*i),24*7) #1month
  fraLoad_test=as.vector(fraLoad_test)
  
  fraLoad_train1=tail(head(fraLoad1,length(fraLoad1)-24*7*i),24*7*4.25) #1month
  
  fraLoad_train2=tail(head(fraLoad,length(fraLoad)-24*7*i),24*7*4.25)
  
  fra.stlm=fraLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(fra.stlm$mean)
  
  fra.tbats=fraLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(fra.tbats,h=24*7)$mean)
  
  fra.ets=ets(fraLoad_train2,lambda = 0)
  fc3=as.vector(forecast(fra.ets,h=24*7)$mean)
  
  fra.mapa=mapaest(fraLoad_train2,paral=2)
  fra.mapa.for=mapafor(fraLoad_train2,fra.mapa,fh=24*7,outplot=0)
  fc4=as.vector(fra.mapa.for$outfor)
  
  fra.sna=snaive(fraLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,fraLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,fraLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,fraLoad_test)[3]/accuracy(fra.sna$mean,fraLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(fraLoad_test-fore_comb1)/(fraLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(fraLoad_test-fore_comb2)/(fraLoad_test+fore_comb2)))

}

fra.comb.maes=colMeans(MAEs,na.rm=T)
fra.comb.relmaes=colMeans(RelMAEs,na.rm=T)
fra.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
fra.comb.maes
fra.comb.relmaes
fra.comb.smapes
```

```{r}
fra.train.mapa=tail(head(fraLoad,length(fraLoad)-24*7),24*7*4.25)
fra.mapa=mapaest(fra.train.mapa,paral=2)

fra.mapa.for=mapafor(fra.train.mapa,fra.mapa,fh=24*7,outplot=1)
fra.fc6=fra.mapa.for$outfor
```

```{r}
fraLoad_test=ts(as.vector(tail(fraLoad,24*7)),frequency = 24)

autoplot(ts(fra.fc6,frequency = 24),color='blue')+
  autolayer(fraLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
fra.fore.comb=0.4*fra.fc1+0.2*fra.fc4+0.2*fra.fc5+0.2*fra.fc6
```

```{r, warning=FALSE}
fraLoad_test=tail(fraLoad,24*7)
fraLoad_test=as.vector(fraLoad_test)

fore=tibble(ID=1:168,fc1=fra.fc1,fc2=fra.fc4,fc3=fra.fc5,fc4=fra.fc6,Comb=fra.fore.comb,Actual=fraLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
fra.fore.comb=ts(fra.fore.comb,frequency = 24)
fraLoad_test=ts(fraLoad_test,frequency = 24)

autoplot(fra.fore.comb,color='blue')+
  autolayer(fraLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
fra.sna=snaive(fraLoad_test,h=24*7)

MAE=accuracy(fra.fore.comb,fraLoad_test)[3]
  
RelMAE=accuracy(fra.fore.comb,fraLoad_test)[3]/accuracy(as.vector(fra.sna$mean),as.vector(fraLoad_test))[3]

sMAPE=mean(200*(abs(fraLoad_test-fra.fore.comb)/(fraLoad_test+fra.fore.comb)))

MAE
RelMAE
sMAPE
```



```{r}
write_csv(as_tibble(fra.stlm$mean),file='fra_forecast.csv')
```

```{r}
write_csv(as_tibble(fra.tbats.fore$mean),file='fra_forecast.csv',append=T,col_names = T)
```

```{r}
write_csv(as_tibble(fra.mapa.for$outfor),file='fra_forecast.csv',append=T,col_names = T)
```

# Belgium

## Decomposition

```{r}
belLoad1=msts(bel_hourly$ActualTotalLoad,seasonal.periods = c(24,24*7))
belLoad1=na_ma(belLoad1)
belLoad2=msts(bel_hourly$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
belLoad2=na_ma(belLoad2)

belLoad=ts(bel_hourly$ActualTotalLoad,frequency = 24)
belLoad=na_ma(belLoad)
```

```{r}
length(as.vector(tsoutliers(belLoad)$index))/length(belLoad)
```

```{r}
out=tsoutliers(belLoad1)

for (o in out$index){
  belLoad1[o]=NA
}

out=tsoutliers(belLoad2)

for (o in out$index){
  belLoad2[o]=NA
}

out=tsoutliers(belLoad)

for (o in out$index){
  belLoad[o]=NA
}

```

```{r}
skimr::skim(belLoad1)
belLoad1=na_ma(belLoad1)
belLoad2=na_ma(belLoad2)
belLoad=na_ma(belLoad)
```



```{r}
belLoad_train2=tail(head(belLoad1,length(belLoad1)-24*7),24*7*4.25) #1month

belLoad_train5=tail(head(belLoad2,length(belLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
belLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
belLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  belLoad_test1=head(tail(belLoad1,4*24*7*i),4*24*7) #2week,1month
  belLoad_test2=head(tail(belLoad2,4*24*7*i),4*24*7) #3month,6month,1year
  
  belLoad_train1=tail(head(belLoad1,length(belLoad1)-4*24*7*i),4*24*7*2+1) #2week
  belLoad_train2=tail(head(belLoad1,length(belLoad1)-4*24*7*i),4*24*7*4.25) #1month
  belLoad_train3=tail(head(belLoad2,length(belLoad2)-4*24*7*i),4*24*7*4.25*3) #3month
  belLoad_train4=tail(head(belLoad2,length(belLoad2)-4*24*7*i),4*24*7*4.25*6) #6month
  belLoad_train5=tail(head(belLoad2,length(belLoad2)-4*24*7*i),4*24*7*4.25*12) #1year
  
  bel.stlm1=belLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=4*24*7)
  
  bel.stlm2=belLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=4*24*7)
  
  bel.stlm3=belLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=4*24*7)
  
  bel.stlm4=belLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=4*24*7)
  
  bel.stlm5=belLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=4*24*7)
  
  bel.sna1=snaive(belLoad_train1,h=4*24*7)
  bel.sna2=snaive(belLoad_train2,h=4*24*7)
  bel.sna3=snaive(belLoad_train3,h=4*24*7)
  bel.sna4=snaive(belLoad_train4,h=4*24*7)
  bel.sna5=snaive(belLoad_train5,h=4*24*7)
  
  MAEs[which(i==1:52),1]=accuracy(bel.stlm1$mean,belLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(bel.stlm2$mean,belLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(bel.stlm3$mean,belLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(bel.stlm4$mean,belLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(bel.stlm5$mean,belLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(bel.stlm1$mean,belLoad_test1)[3]/accuracy(bel.sna1$mean,belLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(bel.stlm2$mean,belLoad_test1)[3]/accuracy(bel.sna2$mean,belLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(bel.stlm3$mean,belLoad_test2)[3]/accuracy(bel.sna3$mean,belLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(bel.stlm4$mean,belLoad_test2)[3]/accuracy(bel.sna4$mean,belLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(bel.stlm5$mean,belLoad_test2)[3]/accuracy(bel.sna5$mean,belLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(belLoad_test1-bel.stlm1$mean)/(belLoad_test1+bel.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(belLoad_test1-bel.stlm2$mean)/(belLoad_test1+bel.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(belLoad_test2-bel.stlm3$mean)/(belLoad_test2+bel.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(belLoad_test2-bel.stlm4$mean)/(belLoad_test2+bel.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(belLoad_test2-bel.stlm5$mean)/(belLoad_test2+bel.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

2 weeks, 1 month, 1 year, 6 months, 3 months

## TBATS

short-term train data can be tested by this model

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  belLoad_test1=head(tail(belLoad1,24*7*i),24*7) #2week,1month
  
  belLoad_train1=tail(head(belLoad1,length(belLoad1)-24*7*i),24*7*2+1) #2week
  belLoad_train2=tail(head(belLoad1,length(belLoad1)-24*7*i),24*7*4.25) #1month
  
  
  bel.tbats1=belLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  bel.tbats.fore1=forecast(bel.tbats1,h=24*7)
  
  bel.tbats2=belLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  bel.tbats.fore2=forecast(bel.tbats2,h=24*7)
  
  
  bel.sna1=snaive(belLoad_train1,h=24*7)
  bel.sna2=snaive(belLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(bel.tbats.fore1$mean,belLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(bel.tbats.fore2$mean,belLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(bel.tbats.fore1$mean,belLoad_test1)[3]/accuracy(bel.sna1$mean,belLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(bel.tbats.fore2$mean,belLoad_test1)[3]/accuracy(bel.sna2$mean,belLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(belLoad_test1-bel.tbats.fore1$mean)/(belLoad_test1+bel.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(belLoad_test1-bel.tbats.fore2$mean)/(belLoad_test1+bel.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  belLoad_test=head(tail(belLoad,24*7*i),24*7)
  belLoad_train1=tail(head(belLoad,length(belLoad)-24*7*i),24*7*2+1)
  belLoad_train2=tail(head(belLoad,length(belLoad)-24*7*i),24*7*4.25)
  belLoad_train3=tail(head(belLoad,length(belLoad)-24*7*i),24*7*4.25*3)
  belLoad_train4=tail(head(belLoad,length(belLoad)-24*7*i),24*7*4.25*6)
  belLoad_train5=tail(head(belLoad,length(belLoad)-24*7*i),24*7*4.25*12)
  
  bel.ets1=ets(belLoad_train1,lambda = 0)
  fc1=forecast(bel.ets1,h=24*7)$mean
  
  bel.ets2=ets(belLoad_train2,lambda = 0)
  fc2=forecast(bel.ets2,h=24*7)$mean
  
  bel.ets3=ets(belLoad_train3,lambda = 0)
  fc3=forecast(bel.ets3,h=24*7)$mean
  
  bel.ets4=ets(belLoad_train4,lambda = 0)
  fc4=forecast(bel.ets4,h=24*7)$mean
  
  bel.ets5=ets(belLoad_train5,lambda = 0)
  fc5=forecast(bel.ets5,h=24*7)$mean
  
  
  bel.sna=snaive(belLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,belLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,belLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,belLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,belLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,belLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(belLoad_test-fc1)/(belLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(belLoad_test-fc2)/(belLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(belLoad_test-fc3)/(belLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(belLoad_test-fc4)/(belLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(belLoad_test-fc5)/(belLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
belweather=read_csv("bel_weather.csv")
belweather$TimeUTC=dmy_hm(belweather$TimeUTC)
belweather$T=as.double(belweather$T)
bel=left_join(bel_hourly,belweather,by="TimeUTC")

belholiday=read_csv("bel_holiday.csv")
belholiday$TimeUTC=dmy_hm(belholiday$TimeUTC)
belholiday$Holiday=as.integer(belholiday$Holiday)
bel=left_join(bel,belholiday,by="TimeUTC")
```

```{r}
belTem=ts(bel$T,frequency=24)
belTem=na_ma(belTem)
belHoli=ts(bel$Holiday,frequency=24)
```

## Final Forecast

### Round 1

```{r}
bel.train.stlm=tail(head(belLoad1,length(belLoad1)-24*7),24*7*4.25*3)
bel.train.tbats=tail(head(belLoad1,length(belLoad1)-24*7),24*7*4.25)

belLoad_test=tail(belLoad,24*7)

bel.stlm=bel.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

bel.fc1=as.vector(bel.stlm$mean)

bel.tbats=bel.train.tbats %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)

bel.tbats.fore=forecast(bel.tbats,h=24*7)

bel.fc2=as.vector(bel.tbats.fore$mean)
```

```{r}
belLoad_train=tail(head(belLoad,length(belLoad)-24*7),24*7*4.25*3)
belHoli_train=tail(head(belHoli,length(belHoli)-24*7),24*7*4.25*3)
belHoli_train=na_ma(belHoli_train)
belHoli_test=tail(belHoli,24*7)
belHoli_test=na_ma(belHoli_test)
```

```{r}
bel.rarima=auto.arima(belLoad_train,xreg=belHoli_train)
bel.rarima.for=forecast(bel.rarima,xreg=belHoli_test)
bel.fc3=as.vector(bel.rarima.for$mean)
```

```{r}
autoplot(bel.rarima.for$mean,color='blue')+
  autolayer(belLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
bel.fore.comb=(bel.fc1+bel.fc2+bel.fc3)/3
```

```{r, warning=FALSE}
belLoad_test=tail(belLoad,24*7)
belLoad_test=as.vector(belLoad_test)

fore=tibble(ID=1:168,fc1=bel.fc1,fc2=bel.fc2,fc3=bel.fc3,Comb=bel.fore.comb,Actual=belLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
bel.fore.comb=ts(bel.fore.comb,frequency = 24)
belLoad_test=ts(belLoad_test,frequency = 24)

autoplot(bel.fore.comb,color='blue')+
  autolayer(belLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
bel.sna=snaive(belLoad_test,h=24*7)

MAE=accuracy(bel.fore.comb,belLoad_test)[3]
  
RelMAE=accuracy(bel.fore.comb,belLoad_test)[3]/accuracy(as.vector(bel.sna$mean),as.vector(belLoad_test))[3]

sMAPE=mean(200*(abs(belLoad_test-bel.fore.comb)/(belLoad_test+bel.fore.comb)))

MAE
RelMAE
sMAPE
```



### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# bel.train.stlm=tail(head(belLoad1,length(belLoad1)-24*7),24*7*4.25)
# 
# bel.stlm=bel.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# bel.fc1=as.vector(bel.stlm$mean)
```

```{r}
belLoad_train=tail(head(belLoad,length(belLoad)-24*7),24*7*4.25*3)
belTem_train=tail(head(belTem,length(belTem)-24*7),24*7*4.25*3)
belTem_test=tail(belTem,24*7)
```

```{r}
bel.rarima=auto.arima(belLoad_train,xreg=belTem_train)
bel.rarima.for=forecast(bel.rarima,xreg=belTem_test)
bel.fc4=as.vector(bel.rarima.for$mean)
```


```{r}
bel.ets.train=tail(head(belLoad,length(belLoad)-24*7),24*7*4.25)
bel.ets=ets(bel.ets.train,lambda = 0)
bel.fc5=as.vector(forecast(bel.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=bel.fc1,fc2=bel.fc2,fc3=bel.fc3,fc4=bel.fc4,fc5=bel.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#bel.fore.comb=rowMeans(fore)

bel.fore.comb=vector()

for (i in 1:168){
  bel.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
belLoad_test=tail(belLoad,24*7)
belLoad_test=as.vector(belLoad_test)

fore=tibble(ID=1:168,fc1=bel.fc1,fc2=bel.fc2,fc3=bel.fc3,fc4=bel.fc4,fc5=bel.fc5,Comb=bel.fore.comb,Actual=belLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
bel.fore.comb=ts(bel.fore.comb,frequency = 24)
belLoad_test=ts(belLoad_test,frequency = 24)

autoplot(bel.fore.comb,color='blue')+
  autolayer(belLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
bel.sna=snaive(belLoad_test,h=24*7)

MAE=accuracy(bel.fore.comb,belLoad_test)[3]
  
RelMAE=accuracy(bel.fore.comb,belLoad_test)[3]/accuracy(as.vector(bel.sna$mean),as.vector(belLoad_test))[3]

sMAPE=mean(200*(abs(belLoad_test-bel.fore.comb)/(belLoad_test+bel.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  belLoad_test=head(tail(belLoad,24*7*i),24*7) #1month
  belLoad_test=as.vector(belLoad_test)
  
  belLoad_train1=tail(head(belLoad1,length(belLoad1)-24*7*i),24*7*4.25) #1month
  
  belLoad_train2=tail(head(belLoad,length(belLoad)-24*7*i),24*7*4.25)
  
  belLoad_train3=tail(head(belLoad1,length(belLoad1)-24*7*i),24*7*4.25*3)
  
  bel.stlm=belLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(bel.stlm$mean)
  
  bel.tbats=belLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(bel.tbats,h=24*7)$mean)
  
  bel.ets=ets(belLoad_train2,lambda = 0)
  fc3=as.vector(forecast(bel.ets,h=24*7)$mean)
  
  bel.mapa=mapaest(belLoad_train2,paral=2)
  bel.mapa.for=mapafor(belLoad_train2,bel.mapa,fh=24*7,outplot=0)
  fc4=as.vector(bel.mapa.for$outfor)
  
  bel.sna=snaive(belLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,belLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,belLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,belLoad_test)[3]/accuracy(bel.sna$mean,belLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(belLoad_test-fore_comb1)/(belLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(belLoad_test-fore_comb2)/(belLoad_test+fore_comb2)))

}

bel.comb.maes=colMeans(MAEs,na.rm=T)
bel.comb.relmaes=colMeans(RelMAEs,na.rm=T)
bel.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
bel.comb.maes
bel.comb.relmaes
bel.comb.smapes
```

```{r}
bel.train.mapa=tail(head(belLoad,length(belLoad)-24*7),24*7*4.25)
bel.mapa=mapaest(bel.train.mapa,paral=2)

bel.mapa.for=mapafor(bel.train.mapa,bel.mapa,fh=24*7,outplot=1)
bel.fc6=bel.mapa.for$outfor
```

```{r}
belLoad_test=ts(as.vector(tail(belLoad,24*7)),frequency = 24)

autoplot(ts(bel.fc6,frequency = 24),color='blue')+
  autolayer(belLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
bel.fore.comb=0.4*bel.fc1+0.2*bel.fc2+0.2*bel.fc5+0.2*bel.fc6
```

```{r, warning=FALSE}
belLoad_test=tail(belLoad,24*7)
belLoad_test=as.vector(belLoad_test)

fore=tibble(ID=1:168,fc1=bel.fc1,fc2=bel.fc4,fc3=bel.fc5,fc4=bel.fc6,Comb=bel.fore.comb,Actual=belLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
bel.fore.comb=ts(bel.fore.comb,frequency = 24)
belLoad_test=ts(belLoad_test,frequency = 24)

autoplot(bel.fore.comb,color='blue')+
  autolayer(belLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
bel.sna=snaive(belLoad_test,h=24*7)

MAE=accuracy(bel.fore.comb,belLoad_test)[3]
  
RelMAE=accuracy(bel.fore.comb,belLoad_test)[3]/accuracy(as.vector(bel.sna$mean),as.vector(belLoad_test))[3]

sMAPE=mean(200*(abs(belLoad_test-bel.fore.comb)/(belLoad_test+bel.fore.comb)))

MAE
RelMAE
sMAPE
```

### Hourly

```{r}
belLoad_multi=msts(bel_hourly$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
belLoad_multi=na_ma(belLoad_multi)

belLoad=ts(bel_hourly$ActualTotalLoad,frequency = 24)
belLoad=na_ma(belLoad)
```


```{r}
bel.train.stlm=tail(belLoad_multi,24*7*4.25*3)

bel.stlm=bel.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=10+24*7)
```

```{r}
bel.tbats=bel.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
bel.tbats.fore=forecast(bel.tbats,h=10+24*7)
```

```{r}
bel.train.mapa=tail(belLoad,24*7*4.25*3)
bel.mapa=mapaest(bel.train.mapa,paral=2)

bel.mapa.for=mapafor(bel.train.mapa,bel.mapa,fh=10+24*7,outplot=1)
```

```{r}
write_csv(as_tibble(bel.stlm$mean),file='bel_forecast.csv')
```

```{r}
write_csv(as_tibble(bel.tbats.fore$mean),file='bel_forecast.csv',append=T,col_names = T)
```

```{r}
write_csv(as_tibble(bel.mapa.for$outfor),file='bel_forecast.csv',append=T,col_names = T)
```

### 15 minutes

```{r}
belLoad_multi=msts(bel$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
belLoad_multi=na_ma(belLoad_multi)

belLoad=ts(bel$ActualTotalLoad,frequency = 24)
belLoad=na_ma(belLoad)
```

```{r}
bel.stlm.train=tail(belLoad_multi,24*7*4.25*6)
  
bel.stlm=bel.stlm.train %>% 
    stlm(lambda=0) %>% 
    forecast(h=39+4*24*7)
```

```{r}
bel.tbats=bel.stlm.train %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
bel.tbats.fore=forecast(bel.tbats,h=39+4*24*7)
```

```{r}
write_csv(as_tibble(bel.stlm$mean),file='bel_forecast.csv',append=TRUE,col_names = T)
```

```{r}
write_csv(as_tibble(bel.tbats.fore$mean),file='bel_forecast.csv',append=TRUE,col_names = T)
```

# Germany

## Decomposition

```{r}
gerLoad1=msts(ger_hourly$ActualTotalLoad,seasonal.periods = c(24,24*7))
gerLoad1=na_ma(gerLoad1)

gerLoad2=msts(ger_hourly$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
gerLoad2=na_ma(gerLoad2)

gerLoad=ts(ger_hourly$ActualTotalLoad,frequency = 24)
gerLoad=na_ma(gerLoad)
```

```{r}
length(as.vector(tsoutliers(gerLoad)$index))/length(gerLoad)
```

```{r}
out=tsoutliers(gerLoad1)

for (o in out$index){
  gerLoad1[o]=NA
}

out=tsoutliers(gerLoad2)

for (o in out$index){
  gerLoad2[o]=NA
}

out=tsoutliers(gerLoad)

for (o in out$index){
  gerLoad[o]=NA
}
```

```{r}
skimr::skim(gerLoad)
gerLoad1=na_ma(gerLoad1)
gerLoad2=na_ma(gerLoad2)
gerLoad=na_ma(gerLoad)
```

```{r}
gerLoad_train2=tail(head(gerLoad1,length(gerLoad1)-24*7),24*7*4.25) #1month

gerLoad_train5=tail(head(gerLoad2,length(gerLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
gerLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
gerLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  gerLoad_test1=head(tail(gerLoad1,24*7*i),24*7) #2week,1month
  gerLoad_test2=head(tail(gerLoad2,24*7*i),24*7) #3month,6month,1year
  
  gerLoad_train1=tail(head(gerLoad1,length(gerLoad1)-24*7*i),24*7*2+1) #2week
  gerLoad_train2=tail(head(gerLoad1,length(gerLoad1)-24*7*i),24*7*4.25) #1month
  gerLoad_train3=tail(head(gerLoad2,length(gerLoad2)-24*7*i),24*7*4.25*3) #3month
  gerLoad_train4=tail(head(gerLoad2,length(gerLoad2)-24*7*i),24*7*4.25*6) #6month
  gerLoad_train5=tail(head(gerLoad2,length(gerLoad2)-24*7*i),24*7*4.25*12) #1year
  
  ger.stlm1=gerLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ger.stlm2=gerLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ger.stlm3=gerLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ger.stlm4=gerLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ger.stlm5=gerLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ger.sna1=snaive(gerLoad_train1,h=24*7)
  ger.sna2=snaive(gerLoad_train2,h=24*7)
  ger.sna3=snaive(gerLoad_train3,h=24*7)
  ger.sna4=snaive(gerLoad_train4,h=24*7)
  ger.sna5=snaive(gerLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(ger.stlm1$mean,gerLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(ger.stlm2$mean,gerLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(ger.stlm3$mean,gerLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(ger.stlm4$mean,gerLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(ger.stlm5$mean,gerLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(ger.stlm1$mean,gerLoad_test1)[3]/accuracy(ger.sna1$mean,gerLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(ger.stlm2$mean,gerLoad_test1)[3]/accuracy(ger.sna2$mean,gerLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(ger.stlm3$mean,gerLoad_test2)[3]/accuracy(ger.sna3$mean,gerLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(ger.stlm4$mean,gerLoad_test2)[3]/accuracy(ger.sna4$mean,gerLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(ger.stlm5$mean,gerLoad_test2)[3]/accuracy(ger.sna5$mean,gerLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(gerLoad_test1-ger.stlm1$mean)/(gerLoad_test1+ger.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(gerLoad_test1-ger.stlm2$mean)/(gerLoad_test1+ger.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(gerLoad_test2-ger.stlm3$mean)/(gerLoad_test2+ger.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(gerLoad_test2-ger.stlm4$mean)/(gerLoad_test2+ger.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(gerLoad_test2-ger.stlm5$mean)/(gerLoad_test2+ger.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  gerLoad_test1=head(tail(gerLoad1,24*7*i),24*7) #2week,1month
  
  gerLoad_train1=tail(head(gerLoad1,length(gerLoad1)-24*7*i),24*7*2+1) #2week
  gerLoad_train2=tail(head(gerLoad1,length(gerLoad1)-24*7*i),24*7*4.25) #1month
  
  
  ger.tbats1=gerLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  ger.tbats.fore1=forecast(ger.tbats1,h=24*7)
  
  ger.tbats2=gerLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  ger.tbats.fore2=forecast(ger.tbats2,h=24*7)
  
  
  ger.sna1=snaive(gerLoad_train1,h=24*7)
  ger.sna2=snaive(gerLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(ger.tbats.fore1$mean,gerLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(ger.tbats.fore2$mean,gerLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(ger.tbats.fore1$mean,gerLoad_test1)[3]/accuracy(ger.sna1$mean,gerLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(ger.tbats.fore2$mean,gerLoad_test1)[3]/accuracy(ger.sna2$mean,gerLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(gerLoad_test1-ger.tbats.fore1$mean)/(gerLoad_test1+ger.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(gerLoad_test1-ger.tbats.fore2$mean)/(gerLoad_test1+ger.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  gerLoad_test=head(tail(gerLoad,24*7*i),24*7)
  gerLoad_train1=tail(head(gerLoad,length(gerLoad)-24*7*i),24*7*2+1)
  gerLoad_train2=tail(head(gerLoad,length(gerLoad)-24*7*i),24*7*4.25)
  gerLoad_train3=tail(head(gerLoad,length(gerLoad)-24*7*i),24*7*4.25*3)
  gerLoad_train4=tail(head(gerLoad,length(gerLoad)-24*7*i),24*7*4.25*6)
  gerLoad_train5=tail(head(gerLoad,length(gerLoad)-24*7*i),24*7*4.25*12)
  
  ger.ets1=ets(gerLoad_train1,lambda = 0)
  fc1=forecast(ger.ets1,h=24*7)$mean
  
  ger.ets2=ets(gerLoad_train2,lambda = 0)
  fc2=forecast(ger.ets2,h=24*7)$mean
  
  ger.ets3=ets(gerLoad_train3,lambda = 0)
  fc3=forecast(ger.ets3,h=24*7)$mean
  
  ger.ets4=ets(gerLoad_train4,lambda = 0)
  fc4=forecast(ger.ets4,h=24*7)$mean
  
  ger.ets5=ets(gerLoad_train5,lambda = 0)
  fc5=forecast(ger.ets5,h=24*7)$mean
  
  
  ger.sna=snaive(gerLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,gerLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,gerLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,gerLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,gerLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,gerLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(gerLoad_test-fc1)/(gerLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(gerLoad_test-fc2)/(gerLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(gerLoad_test-fc3)/(gerLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(gerLoad_test-fc4)/(gerLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(gerLoad_test-fc5)/(gerLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
gerweather=read_csv("ger_weather.csv")
gerweather$TimeUTC=dmy_hm(gerweather$TimeUTC)
gerweather$T=as.double(gerweather$T)
ger=left_join(ger_hourly,gerweather,by="TimeUTC")

gerholiday=read_csv("ger_holiday.csv")
gerholiday$TimeUTC=dmy_hm(gerholiday$TimeUTC)
gerholiday$Holiday=as.integer(gerholiday$Holiday)
ger=left_join(ger,gerholiday,by="TimeUTC")
```

```{r}
gerTem=ts(ger$T,frequency=24)
gerTem=na_ma(gerTem)
gerHoli=ts(ger$Holiday,frequency=24)
```

## Final Forecast

### Round 1

```{r}
ger.train.stlm=tail(head(gerLoad1,length(gerLoad1)-24*7),24*7*4.25*12)
gerLoad_test=tail(gerLoad,24*7)

ger.stlm=ger.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

ger.fc1=as.vector(ger.stlm$mean)
```

```{r}
gerLoad_train=tail(head(gerLoad,length(gerLoad)-24*7),24*7*4.25*12)
gerHoli_train=tail(head(gerHoli,length(gerHoli)-24*7),24*7*4.25*12)
gerHoli_train=na_ma(gerHoli_train)
gerHoli_test=tail(gerHoli,24*7)
```

```{r}
ger.rarima=auto.arima(gerLoad_train,xreg=gerHoli_train)
ger.rarima.for=forecast(ger.rarima,xreg=gerHoli_test)
ger.fc2=as.vector(ger.rarima.for$mean)
```

```{r}
autoplot(ger.rarima.for$mean,color='blue')+
  autolayer(gerLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
ger.fore.comb=(ger.fc1+ger.fc2)/2
```

```{r, warning=FALSE}
gerLoad_test=tail(gerLoad,24*7)
gerLoad_test=as.vector(gerLoad_test)

fore=tibble(ID=1:168,fc1=ger.fc1,fc2=ger.fc2,Comb=ger.fore.comb,Actual=gerLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
ger.fore.comb=ts(ger.fore.comb,frequency = 24)
gerLoad_test=ts(gerLoad_test,frequency = 24)

autoplot(ger.fore.comb,color='blue')+
  autolayer(gerLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
ger.sna=snaive(gerLoad_test,h=24*7)

MAE=accuracy(ger.fore.comb,gerLoad_test)[3]
  
RelMAE=accuracy(ger.fore.comb,gerLoad_test)[3]/accuracy(as.vector(ger.sna$mean),as.vector(gerLoad_test))[3]

sMAPE=mean(200*(abs(gerLoad_test-ger.fore.comb)/(gerLoad_test+ger.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# ger.train.stlm=tail(head(gerLoad1,length(gerLoad1)-24*7),24*7*4.25)
# 
# ger.stlm=ger.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# ger.fc1=as.vector(ger.stlm$mean)
```

```{r}
gerLoad_train=tail(head(gerLoad,length(gerLoad)-24*7),24*7*4.25*12)
gerTem_train=tail(head(gerTem,length(gerTem)-24*7),24*7*4.25*12)
gerTem_test=tail(gerTem,24*7)
```

```{r}
ger.rarima=auto.arima(gerLoad_train,xreg=gerTem_train)
ger.rarima.for=forecast(ger.rarima,xreg=gerTem_test)
ger.fc3=as.vector(ger.rarima.for$mean)
```

```{r}
ger.tbats.train=tail(head(gerLoad1,length(gerLoad1)-24*7),24*7*4.25)
ger.tbats=ger.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
ger.tbats.fore=forecast(ger.tbats,h=24*7)
ger.fc4=as.vector(ger.tbats.fore$mean)
```

```{r}
ger.ets.train=tail(head(gerLoad,length(gerLoad)-24*7),24*7*4.25)
ger.ets=ets(ger.ets.train,lambda = 0)
ger.fc5=as.vector(forecast(ger.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=ger.fc1,fc2=ger.fc4,fc3=ger.fc2,fc4=ger.fc3,fc5=ger.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#ger.fore.comb=rowMeans(fore)

ger.fore.comb=vector()

for (i in 1:168){
  ger.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
gerLoad_test=tail(gerLoad,24*7)
gerLoad_test=as.vector(gerLoad_test)

fore=tibble(ID=1:168,fc1=ger.fc1,fc2=ger.fc4,fc3=ger.fc2,fc4=ger.fc3,fc5=ger.fc5,Comb=ger.fore.comb,Actual=gerLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.text.y=element_text(size=9))
```

```{r}
ger.fore.comb=ts(ger.fore.comb,frequency = 24)
gerLoad_test=ts(gerLoad_test,frequency = 24)

autoplot(ger.fore.comb,color='blue')+
  autolayer(gerLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
ger.sna=snaive(gerLoad_test,h=24*7)

MAE=accuracy(ger.fore.comb,gerLoad_test)[3]
  
RelMAE=accuracy(ger.fore.comb,gerLoad_test)[3]/accuracy(as.vector(ger.sna$mean),as.vector(gerLoad_test))[3]

sMAPE=mean(200*(abs(gerLoad_test-ger.fore.comb)/(gerLoad_test+ger.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  gerLoad_test=head(tail(gerLoad,24*7*i),24*7)
  gerLoad_test=as.vector(gerLoad_test)
  
  gerLoad_train1=tail(head(gerLoad1,length(gerLoad1)-24*7*i),24*7*4.25) 
  
  gerLoad_train2=tail(head(gerLoad,length(gerLoad)-24*7*i),24*7*4.25)
  
  gerLoad_train3=tail(head(gerLoad1,length(gerLoad1)-24*7*i),24*7*4.25*12)
  
  ger.stlm=gerLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(ger.stlm$mean)
  
  ger.tbats=gerLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(ger.tbats,h=24*7)$mean)
  
  ger.ets=ets(gerLoad_train2,lambda = 0)
  fc3=as.vector(forecast(ger.ets,h=24*7)$mean)
  
  ger.mapa=mapaest(gerLoad_train2,paral=2)
  ger.mapa.for=mapafor(gerLoad_train2,ger.mapa,fh=24*7,outplot=0)
  fc4=as.vector(ger.mapa.for$outfor)
  
  ger.sna=snaive(gerLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,gerLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,gerLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,gerLoad_test)[3]/accuracy(ger.sna$mean,gerLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(gerLoad_test-fore_comb1)/(gerLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(gerLoad_test-fore_comb2)/(gerLoad_test+fore_comb2)))

}

ger.comb.maes=colMeans(MAEs,na.rm=T)
ger.comb.relmaes=colMeans(RelMAEs,na.rm=T)
ger.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
ger.comb.maes
ger.comb.relmaes
ger.comb.smapes
```

```{r}
ger.train.mapa=tail(head(gerLoad,length(gerLoad)-24*7),24*7*4.25)
ger.mapa=mapaest(ger.train.mapa,paral=2)

ger.mapa.for=mapafor(ger.train.mapa,ger.mapa,fh=24*7,outplot=1)
ger.fc6=ger.mapa.for$outfor
```

```{r}
gerLoad_test=ts(as.vector(tail(gerLoad,24*7)),frequency = 24)

autoplot(ts(ger.fc6,frequency = 24),color='blue')+
  autolayer(gerLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
ger.fore.comb=0.4*ger.fc1+0.2*ger.fc4+0.2*ger.fc5+0.2*ger.fc6
```

```{r, warning=FALSE}
gerLoad_test=tail(gerLoad,24*7)
gerLoad_test=as.vector(gerLoad_test)

fore=tibble(ID=1:168,fc1=ger.fc1,fc2=ger.fc4,fc3=ger.fc5,fc4=ger.fc6,Comb=ger.fore.comb,Actual=gerLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
ger.fore.comb=ts(ger.fore.comb,frequency = 24)
gerLoad_test=ts(gerLoad_test,frequency = 24)

autoplot(ger.fore.comb,color='blue')+
  autolayer(gerLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
ger.sna=snaive(gerLoad_test,h=24*7)

MAE=accuracy(ger.fore.comb,gerLoad_test)[3]
  
RelMAE=accuracy(ger.fore.comb,gerLoad_test)[3]/accuracy(as.vector(ger.sna$mean),as.vector(gerLoad_test))[3]

sMAPE=mean(200*(abs(gerLoad_test-ger.fore.comb)/(gerLoad_test+ger.fore.comb)))

MAE
RelMAE
sMAPE
```

```{r}
write_csv(as_tibble(ger.stlm$mean),file='ger_forecast.csv')
```

```{r}
write_csv(as_tibble(ger.tbats.fore$mean),file='ger_forecast.csv',append=T,col_names = T)
```

```{r}
write_csv(as_tibble(ger.mapa.for$outfor),file='ger_forecast.csv',append=T,col_names = T)
```

### 15 minutes
```{r}
gerA1Load=msts(gerA1$ActualTotalLoad,seasonal.periods = c(4,4*24,4*24*7))
gerA1Load=na_ma(gerA1Load)
gerA2Load=msts(gerA1$ActualTotalLoad,seasonal.periods = c(4,4*24,4*24*7))
gerA2Load=na_ma(gerA2Load)
gerA3Load=msts(gerA1$ActualTotalLoad,seasonal.periods = c(4,4*24,4*24*7))
gerA3Load=na_ma(gerA3Load)
gerA4Load=msts(gerA1$ActualTotalLoad,seasonal.periods = c(4,4*24,4*24*7))
gerA4Load=na_ma(gerA4Load)
```

```{r}
gerA1.train=tail(gerA1Load,4*24*7*4.25)
gerA2.train=tail(gerA2Load,4*24*7*4.25)
gerA3.train=tail(gerA3Load,4*24*7*4.25)
gerA4.train=tail(gerA4Load,4*24*7*4.25)
```


```{r}
ger.stlm1=gerA1.train %>% 
  stlm(lambda=0) %>% 
  forecast(h=38+4*24*7)

ger.stlm2=gerA2.train %>% 
  stlm(lambda=0) %>% 
  forecast(h=38+4*24*7)

ger.stlm3=gerA3.train %>% 
  stlm(lambda=0) %>% 
  forecast(h=38+4*24*7)

ger.stlm4=gerA4.train %>% 
  stlm(lambda=0) %>% 
  forecast(h=38+4*24*7)
```

```{r}
ger.tbats1=gerA1.train %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)

ger.tbats2=gerA2.train %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)

ger.tbats3=gerA3.train %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)

ger.tbats4=gerA4.train %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
ger.tbats.fore1=forecast(ger.tbats1,h=38+4*24*7)
ger.tbats.fore2=forecast(ger.tbats2,h=38+4*24*7)
ger.tbats.fore3=forecast(ger.tbats3,h=38+4*24*7)
ger.tbats.fore4=forecast(ger.tbats4,h=38+4*24*7)
```

```{r}
combination=(ger.stlm1$mean+ger.tbats.fore1$mean+ger.stlm2$mean+ger.tbats.fore2$mean+ger.stlm3$mean+ger.tbats.fore3$mean+ger.stlm4$mean+ger.tbats.fore4$mean)/2
```

```{r}
write_csv(as_tibble(combination),file='ger_forecast.csv')
```

# Greece

## Decomposition

```{r}
greLoad1=msts(gre$ActualTotalLoad,seasonal.periods = c(24,24*7))
greLoad1=na_ma(greLoad1)
greLoad2=msts(gre$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
greLoad2=na_ma(greLoad2)

greLoad=ts(gre$ActualTotalLoad,frequency=24)
greLoad=na_ma(greLoad)
```

```{r}
length(as.vector(tsoutliers(greLoad)$index))/length(greLoad)
```

```{r}
out=tsoutliers(greLoad1)

for (o in out$index){
  greLoad1[o]=NA
}

out=tsoutliers(greLoad2)

for (o in out$index){
  greLoad2[o]=NA
}

out=tsoutliers(greLoad)

for (o in out$index){
  greLoad[o]=NA
}
```

```{r}
skimr::skim(greLoad1)
greLoad1=na_ma(greLoad1)
greLoad2=na_ma(greLoad2)
greLoad=na_ma(greLoad)
```


```{r}
greLoad_train2=tail(head(greLoad1,length(greLoad1)-24*7),24*7*4.25) #1month

greLoad_train5=tail(head(greLoad2,length(greLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
greLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
greLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  greLoad_test1=head(tail(greLoad1,24*7*i),24*7) #2week,1month
  greLoad_test2=head(tail(greLoad2,24*7*i),24*7) #3month,6month,1year
  
  greLoad_train1=tail(head(greLoad1,length(greLoad1)-24*7*i),24*7*2+1) #2week
  greLoad_train2=tail(head(greLoad1,length(greLoad1)-24*7*i),24*7*4.25) #1month
  greLoad_train3=tail(head(greLoad2,length(greLoad2)-24*7*i),24*7*4.25*3) #3month
  greLoad_train4=tail(head(greLoad2,length(greLoad2)-24*7*i),24*7*4.25*6) #6month
  greLoad_train5=tail(head(greLoad2,length(greLoad2)-24*7*i),24*7*4.25*12) #1year
  
  gre.stlm1=greLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  gre.stlm2=greLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  gre.stlm3=greLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  gre.stlm4=greLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  gre.stlm5=greLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  gre.sna1=snaive(greLoad_train1,h=24*7)
  gre.sna2=snaive(greLoad_train2,h=24*7)
  gre.sna3=snaive(greLoad_train3,h=24*7)
  gre.sna4=snaive(greLoad_train4,h=24*7)
  gre.sna5=snaive(greLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(gre.stlm1$mean,greLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(gre.stlm2$mean,greLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(gre.stlm3$mean,greLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(gre.stlm4$mean,greLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(gre.stlm5$mean,greLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(gre.stlm1$mean,greLoad_test1)[3]/accuracy(gre.sna1$mean,greLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(gre.stlm2$mean,greLoad_test1)[3]/accuracy(gre.sna2$mean,greLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(gre.stlm3$mean,greLoad_test2)[3]/accuracy(gre.sna3$mean,greLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(gre.stlm4$mean,greLoad_test2)[3]/accuracy(gre.sna4$mean,greLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(gre.stlm5$mean,greLoad_test2)[3]/accuracy(gre.sna5$mean,greLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(greLoad_test1-gre.stlm1$mean)/(greLoad_test1+gre.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(greLoad_test1-gre.stlm2$mean)/(greLoad_test1+gre.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(greLoad_test2-gre.stlm3$mean)/(greLoad_test2+gre.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(greLoad_test2-gre.stlm4$mean)/(greLoad_test2+gre.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(greLoad_test2-gre.stlm5$mean)/(greLoad_test2+gre.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  greLoad_test1=head(tail(greLoad1,24*7*i),24*7) #2week,1month
  
  greLoad_train1=tail(head(greLoad1,length(greLoad1)-24*7*i),24*7*2+1) #2week
  greLoad_train2=tail(head(greLoad1,length(greLoad1)-24*7*i),24*7*4.25) #1month
  
  
  gre.tbats1=greLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  gre.tbats.fore1=forecast(gre.tbats1,h=24*7)
  
  gre.tbats2=greLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  gre.tbats.fore2=forecast(gre.tbats2,h=24*7)
  
  
  gre.sna1=snaive(greLoad_train1,h=24*7)
  gre.sna2=snaive(greLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(gre.tbats.fore1$mean,greLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(gre.tbats.fore2$mean,greLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(gre.tbats.fore1$mean,greLoad_test1)[3]/accuracy(gre.sna1$mean,greLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(gre.tbats.fore2$mean,greLoad_test1)[3]/accuracy(gre.sna2$mean,greLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(greLoad_test1-gre.tbats.fore1$mean)/(greLoad_test1+gre.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(greLoad_test1-gre.tbats.fore2$mean)/(greLoad_test1+gre.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  greLoad_test=head(tail(greLoad,24*7*i),24*7)
  greLoad_train1=tail(head(greLoad,length(greLoad)-24*7*i),24*7*2+1)
  greLoad_train2=tail(head(greLoad,length(greLoad)-24*7*i),24*7*4.25)
  greLoad_train3=tail(head(greLoad,length(greLoad)-24*7*i),24*7*4.25*3)
  greLoad_train4=tail(head(greLoad,length(greLoad)-24*7*i),24*7*4.25*6)
  greLoad_train5=tail(head(greLoad,length(greLoad)-24*7*i),24*7*4.25*12)
  
  gre.ets1=ets(greLoad_train1,lambda = 0)
  fc1=forecast(gre.ets1,h=24*7)$mean
  
  gre.ets2=ets(greLoad_train2,lambda = 0)
  fc2=forecast(gre.ets2,h=24*7)$mean
  
  gre.ets3=ets(greLoad_train3,lambda = 0)
  fc3=forecast(gre.ets3,h=24*7)$mean
  
  gre.ets4=ets(greLoad_train4,lambda = 0)
  fc4=forecast(gre.ets4,h=24*7)$mean
  
  gre.ets5=ets(greLoad_train5,lambda = 0)
  fc5=forecast(gre.ets5,h=24*7)$mean
  
  
  gre.sna=snaive(greLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,greLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,greLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,greLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,greLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,greLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(greLoad_test-fc1)/(greLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(greLoad_test-fc2)/(greLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(greLoad_test-fc3)/(greLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(greLoad_test-fc4)/(greLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(greLoad_test-fc5)/(greLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
greweather=read_csv("gre_weather.csv")
greweather$TimeUTC=dmy_hm(greweather$TimeUTC)
greweather$T=as.double(greweather$T)
gre=left_join(gre,greweather,by="TimeUTC")

greholiday=read_csv("gre_holiday.csv")
greholiday$TimeUTC=dmy_hm(greholiday$TimeUTC)
greholiday$Holiday=as.integer(greholiday$Holiday)
gre=left_join(gre,greholiday,by="TimeUTC")
```

```{r}
greTem=ts(gre$T,frequency=24)
greTem=na_ma(greTem)
greHoli=ts(gre$Holiday,frequency=24)

greLoad_train=tail(head(greLoad,length(greLoad)-24*7),24*7*4.25*6)
greLoad_test=tail(greLoad,24*7)
greTem_train=tail(head(greTem,length(greTem)-24*7),24*7*4.25*6)
greTem_test=tail(greTem,24*7)
greHoli_train=tail(head(greHoli,length(greHoli)-24*7),24*7*4.25*6)
greHoli_test=tail(greHoli,24*7)
```

```{r}
gre.rarima=auto.arima(greLoad_train,xreg=greHoli_train)
gre.rarima.for=forecast(gre.rarima,xreg=greHoli_test)
```

```{r}
gre.rarima=auto.arima(greLoad_train,xreg=greTem_train)
gre.rarima.for=forecast(gre.rarima,xreg=greTem_test)
```

```{r}
gre.rarima=auto.arima(greLoad_train)
gre.rarima.for=forecast(gre.rarima,h=24*7)
```

```{r}
autoplot(gre.rarima.for$mean,color='blue')+
  autolayer(greLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

## Final Forecast

### Round 1

```{r}
gre.train.stlm=tail(head(greLoad1,length(greLoad1)-24*7),24*7*4.25)
greLoad_test=tail(greLoad,24*7)

gre.stlm=gre.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

gre.fc1=as.vector(gre.stlm$mean)
```

```{r}
greLoad_train=tail(head(greLoad,length(greLoad)-24*7),24*7*4.25)
greHoli_train=tail(head(greHoli,length(greHoli)-24*7),24*7*4.25)
greHoli_train=na_ma(greHoli_train)
greHoli_test=tail(greHoli,24*7)
```

```{r}
gre.rarima=auto.arima(greLoad_train,xreg=greHoli_train)
gre.rarima.for=forecast(gre.rarima,xreg=greHoli_test)
gre.fc2=as.vector(gre.rarima.for$mean)
```

```{r}
autoplot(gre.rarima.for$mean,color='blue')+
  autolayer(greLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
gre.fore.comb=(gre.fc1+gre.fc2)/2
```

```{r, warning=FALSE}
greLoad_test=tail(greLoad,24*7)
greLoad_test=as.vector(greLoad_test)

fore=tibble(ID=1:168,fc1=gre.fc1,fc2=gre.fc2,Comb=gre.fore.comb,Actual=greLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
gre.fore.comb=ts(gre.fore.comb,frequency = 24)
greLoad_test=ts(greLoad_test,frequency = 24)

autoplot(gre.fore.comb,color='blue')+
  autolayer(greLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
gre.sna=snaive(greLoad_test,h=24*7)

MAE=accuracy(gre.fore.comb,greLoad_test)[3]
  
RelMAE=accuracy(gre.fore.comb,greLoad_test)[3]/accuracy(as.vector(gre.sna$mean),as.vector(greLoad_test))[3]

sMAPE=mean(200*(abs(greLoad_test-gre.fore.comb)/(greLoad_test+gre.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# gre.train.stlm=tail(head(greLoad1,length(greLoad1)-24*7),24*7*4.25)
# 
# gre.stlm=gre.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# gre.fc1=as.vector(gre.stlm$mean)
```

```{r}
greLoad_train=tail(head(greLoad,length(greLoad)-24*7),24*7*4.25)
greTem_train=tail(head(greTem,length(greTem)-24*7),24*7*4.25)
greTem_test=tail(greTem,24*7)
```

```{r}
gre.rarima=auto.arima(greLoad_train,xreg=greTem_train)
gre.rarima.for=forecast(gre.rarima,xreg=greTem_test)
gre.fc3=as.vector(gre.rarima.for$mean)
```

```{r}
gre.tbats.train=tail(head(greLoad1,length(greLoad1)-24*7),24*7*4.25)
gre.tbats=gre.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
gre.tbats.fore=forecast(gre.tbats,h=24*7)
gre.fc4=as.vector(gre.tbats.fore$mean)
```

```{r}
gre.ets.train=tail(head(greLoad,length(greLoad)-24*7),24*7*4.25)
gre.ets=ets(gre.ets.train,lambda = 0)
gre.fc5=as.vector(forecast(gre.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=gre.fc1,fc2=gre.fc4,fc3=gre.fc2,fc4=gre.fc3,fc5=gre.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#gre.fore.comb=rowMeans(fore)

gre.fore.comb=vector()

for (i in 1:168){
  gre.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
greLoad_test=tail(greLoad,24*7)
greLoad_test=as.vector(greLoad_test)

fore=tibble(ID=1:168,fc1=gre.fc1,fc2=gre.fc4,fc3=gre.fc2,fc4=gre.fc3,fc5=gre.fc5,Comb=gre.fore.comb,Actual=greLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
gre.fore.comb=ts(gre.fore.comb,frequency = 24)
greLoad_test=ts(greLoad_test,frequency = 24)

autoplot(gre.fore.comb,color='blue')+
  autolayer(greLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
gre.sna=snaive(greLoad_test,h=24*7)

MAE=accuracy(gre.fore.comb,greLoad_test)[3]
  
RelMAE=accuracy(gre.fore.comb,greLoad_test)[3]/accuracy(as.vector(gre.sna$mean),as.vector(greLoad_test))[3]

sMAPE=mean(200*(abs(greLoad_test-gre.fore.comb)/(greLoad_test+gre.fore.comb)))

MAE
RelMAE
sMAPE
```


### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  greLoad_test=head(tail(greLoad,24*7*i),24*7)
  greLoad_test=as.vector(greLoad_test)
  
  greLoad_train1=tail(head(greLoad1,length(greLoad1)-24*7*i),24*7*4.25) 
  
  greLoad_train2=tail(head(greLoad,length(greLoad)-24*7*i),24*7*4.25)
  
  gre.stlm=greLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(gre.stlm$mean)
  
  gre.tbats=greLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(gre.tbats,h=24*7)$mean)
  
  gre.ets=ets(greLoad_train2,lambda = 0)
  fc3=as.vector(forecast(gre.ets,h=24*7)$mean)
  
  gre.mapa=mapaest(greLoad_train2,paral=2)
  gre.mapa.for=mapafor(greLoad_train2,gre.mapa,fh=24*7,outplot=0)
  fc4=as.vector(gre.mapa.for$outfor)
  
  gre.sna=snaive(greLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,greLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,greLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,greLoad_test)[3]/accuracy(gre.sna$mean,greLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(greLoad_test-fore_comb1)/(greLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(greLoad_test-fore_comb2)/(greLoad_test+fore_comb2)))

}

gre.comb.maes=colMeans(MAEs,na.rm=T)
gre.comb.relmaes=colMeans(RelMAEs,na.rm=T)
gre.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
gre.comb.maes
gre.comb.relmaes
gre.comb.smapes
```

```{r}
gre.train.mapa=tail(head(greLoad,length(greLoad)-24*7),24*7*4.25)
gre.mapa=mapaest(gre.train.mapa,paral=2)

gre.mapa.for=mapafor(gre.train.mapa,gre.mapa,fh=24*7,outplot=1)
gre.fc6=gre.mapa.for$outfor
```

```{r}
greLoad_test=ts(as.vector(tail(greLoad,24*7)),frequency = 24)

autoplot(ts(gre.fc6,frequency = 24),color='blue')+
  autolayer(greLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
gre.fore.comb=0.4*gre.fc1+0.2*gre.fc4+0.2*gre.fc5+0.2*gre.fc6
```

```{r, warning=FALSE}
greLoad_test=tail(greLoad,24*7)
greLoad_test=as.vector(greLoad_test)

fore=tibble(ID=1:168,fc1=gre.fc1,fc2=gre.fc4,fc3=gre.fc5,fc4=gre.fc6,Comb=gre.fore.comb,Actual=greLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
gre.fore.comb=ts(gre.fore.comb,frequency = 24)
greLoad_test=ts(greLoad_test,frequency = 24)

autoplot(gre.fore.comb,color='blue')+
  autolayer(greLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
gre.sna=snaive(greLoad_test,h=24*7)

MAE=accuracy(gre.fore.comb,greLoad_test)[3]
  
RelMAE=accuracy(gre.fore.comb,greLoad_test)[3]/accuracy(as.vector(gre.sna$mean),as.vector(greLoad_test))[3]

sMAPE=mean(200*(abs(greLoad_test-gre.fore.comb)/(greLoad_test+gre.fore.comb)))

MAE
RelMAE
sMAPE
```







```{r}
write_csv(as_tibble(gre.stlm$mean),file='gre_forecast.csv')
```

```{r}
write_csv(as_tibble(gre.tbats.fore$mean),file='gre_forecast.csv',append = T,col_names = T)
```

```{r}
write_csv(as_tibble(gre.mapa.for$outfor),file='gre_forecast.csv',append = T,col_names = T)
```

```{r}
gre.train.load=tail(greLoad,24*7*4.25*6)
gre.train.tem=tail(greTem,24*7*4.25*6)
gre.train.holi=tail(greHoli,24*7*4.25*6)
```

```{r}
greTem_fore=read_csv("gre_weather_fore.csv")
greHoli_fore=read_csv("gre_holidays_fore.csv")

greTem_fore$TimeUTC=dmy_hm(greTem_fore$TimeUTC)
greTem_fore$T=as.double(greTem_fore$T)

greHoli_fore$TimeUTC=dmy_hm(greHoli_fore$TimeUTC)
greHoli_fore$Holiday=as.double(greHoli_fore$Holiday)
```

```{r}
gretem.for=ts(greTem_fore$T,freq=24)
greholi.for=ts(greHoli_fore$Holiday,freq=24)
```


```{r}
gre.rarima=auto.arima(gre.train.load,xreg=gre.train.tem)
gre.rarima.for=forecast(gre.rarima,xreg=gretem.for)
```

```{r}
gre.rarima=auto.arima(gre.train.load,xreg=gre.train.holi)
gre.rarima.for=forecast(gre.rarima,xreg=greholi.for)
```

```{r}
write_csv(as_tibble(gre.rarima.for$mean),file='gre_forecast.csv',append = T,col_names = T)
```


# Italy

## Decomposition

```{r}
itaLoad1=msts(ita$ActualTotalLoad,seasonal.periods = c(24,24*7))
itaLoad1=na_ma(itaLoad1)
itaLoad2=msts(ita$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
itaLoad2=na_ma(itaLoad2)

itaLoad=ts(ita$ActualTotalLoad,frequency = 24)
itaLoad=na_ma(itaLoad)
```

```{r}
length(as.vector(tsoutliers(itaLoad)$index))/length(itaLoad)
```

```{r}
out=tsoutliers(itaLoad1)

for (o in out$index){
  itaLoad1[o]=NA
}

out=tsoutliers(itaLoad2)

for (o in out$index){
  itaLoad2[o]=NA
}

out=tsoutliers(itaLoad)

for (o in out$index){
  itaLoad[o]=NA
}
```

```{r}
skimr::skim(itaLoad1)
itaLoad1=na_ma(itaLoad1)
itaLoad2=na_ma(itaLoad2)
itaLoad=na_ma(itaLoad)
```


```{r}
itaLoad_train2=tail(head(itaLoad1,length(itaLoad1)-24*7),24*7*4.25) #1month

itaLoad_train5=tail(head(itaLoad2,length(itaLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
itaLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
itaLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  itaLoad_test1=head(tail(itaLoad1,24*7*i),24*7) #2week,1month
  itaLoad_test2=head(tail(itaLoad2,24*7*i),24*7) #3month,6month,1year
  
  itaLoad_train1=tail(head(itaLoad1,length(itaLoad1)-24*7*i),24*7*2+1) #2week
  itaLoad_train2=tail(head(itaLoad1,length(itaLoad1)-24*7*i),24*7*4.25) #1month
  itaLoad_train3=tail(head(itaLoad2,length(itaLoad2)-24*7*i),24*7*4.25*3) #3month
  itaLoad_train4=tail(head(itaLoad2,length(itaLoad2)-24*7*i),24*7*4.25*6) #6month
  itaLoad_train5=tail(head(itaLoad2,length(itaLoad2)-24*7*i),24*7*4.25*12) #1year
  
  ita.stlm1=itaLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ita.stlm2=itaLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ita.stlm3=itaLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ita.stlm4=itaLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ita.stlm5=itaLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  ita.sna1=snaive(itaLoad_train1,h=24*7)
  ita.sna2=snaive(itaLoad_train2,h=24*7)
  ita.sna3=snaive(itaLoad_train3,h=24*7)
  ita.sna4=snaive(itaLoad_train4,h=24*7)
  ita.sna5=snaive(itaLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(ita.stlm1$mean,itaLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(ita.stlm2$mean,itaLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(ita.stlm3$mean,itaLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(ita.stlm4$mean,itaLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(ita.stlm5$mean,itaLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(ita.stlm1$mean,itaLoad_test1)[3]/accuracy(ita.sna1$mean,itaLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(ita.stlm2$mean,itaLoad_test1)[3]/accuracy(ita.sna2$mean,itaLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(ita.stlm3$mean,itaLoad_test2)[3]/accuracy(ita.sna3$mean,itaLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(ita.stlm4$mean,itaLoad_test2)[3]/accuracy(ita.sna4$mean,itaLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(ita.stlm5$mean,itaLoad_test2)[3]/accuracy(ita.sna5$mean,itaLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(itaLoad_test1-ita.stlm1$mean)/(itaLoad_test1+ita.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(itaLoad_test1-ita.stlm2$mean)/(itaLoad_test1+ita.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(itaLoad_test2-ita.stlm3$mean)/(itaLoad_test2+ita.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(itaLoad_test2-ita.stlm4$mean)/(itaLoad_test2+ita.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(itaLoad_test2-ita.stlm5$mean)/(itaLoad_test2+ita.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  itaLoad_test1=head(tail(itaLoad1,24*7*i),24*7) #2week,1month
  
  itaLoad_train1=tail(head(itaLoad1,length(itaLoad1)-24*7*i),24*7*2+1) #2week
  itaLoad_train2=tail(head(itaLoad1,length(itaLoad1)-24*7*i),24*7*4.25) #1month
  
  
  ita.tbats1=itaLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  ita.tbats.fore1=forecast(ita.tbats1,h=24*7)
  
  ita.tbats2=itaLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  ita.tbats.fore2=forecast(ita.tbats2,h=24*7)
  
  
  ita.sna1=snaive(itaLoad_train1,h=24*7)
  ita.sna2=snaive(itaLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(ita.tbats.fore1$mean,itaLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(ita.tbats.fore2$mean,itaLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(ita.tbats.fore1$mean,itaLoad_test1)[3]/accuracy(ita.sna1$mean,itaLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(ita.tbats.fore2$mean,itaLoad_test1)[3]/accuracy(ita.sna2$mean,itaLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(itaLoad_test1-ita.tbats.fore1$mean)/(itaLoad_test1+ita.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(itaLoad_test1-ita.tbats.fore2$mean)/(itaLoad_test1+ita.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  itaLoad_test=head(tail(itaLoad,24*7*i),24*7)
  itaLoad_train1=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*2+1)
  itaLoad_train2=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*4.25)
  itaLoad_train3=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*4.25*3)
  itaLoad_train4=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*4.25*6)
  itaLoad_train5=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*4.25*12)
  
  ita.ets1=ets(itaLoad_train1,lambda = 0)
  fc1=forecast(ita.ets1,h=24*7)$mean
  
  ita.ets2=ets(itaLoad_train2,lambda = 0)
  fc2=forecast(ita.ets2,h=24*7)$mean
  
  ita.ets3=ets(itaLoad_train3,lambda = 0)
  fc3=forecast(ita.ets3,h=24*7)$mean
  
  ita.ets4=ets(itaLoad_train4,lambda = 0)
  fc4=forecast(ita.ets4,h=24*7)$mean
  
  ita.ets5=ets(itaLoad_train5,lambda = 0)
  fc5=forecast(ita.ets5,h=24*7)$mean
  
  
  ita.sna=snaive(itaLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,itaLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,itaLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,itaLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,itaLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,itaLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(itaLoad_test-fc1)/(itaLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(itaLoad_test-fc2)/(itaLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(itaLoad_test-fc3)/(itaLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(itaLoad_test-fc4)/(itaLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(itaLoad_test-fc5)/(itaLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
itaweather=read_csv("ita_weather.csv")
itaweather$TimeUTC=dmy_hm(itaweather$TimeUTC)
itaweather$T=as.double(itaweather$T)
ita=left_join(ita,itaweather,by="TimeUTC")

itaholiday=read_csv("ita_holiday.csv")
itaholiday$TimeUTC=dmy_hm(itaholiday$TimeUTC)
itaholiday$Holiday=as.integer(itaholiday$Holiday)
ita=left_join(ita,itaholiday,by="TimeUTC")
```

```{r}
itaTem=ts(ita$T,frequency=24)
itaTem=na_ma(itaTem)
itaHoli=ts(ita$Holiday,frequency=24)
```

## Final forecasts

### Round 1

```{r}
ita.train.stlm=tail(head(itaLoad1,length(itaLoad1)-24*7),24*7*4.25*12)
itaLoad_test=tail(itaLoad,24*7)

ita.stlm=ita.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

ita.fc1=as.vector(ita.stlm$mean)
```

```{r}
itaLoad_train=tail(head(itaLoad,length(itaLoad)-24*7),24*7*4.25*12)
itaHoli_train=tail(head(itaHoli,length(itaHoli)-24*7),24*7*4.25*12)
itaHoli_train=na_ma(itaHoli_train)
itaHoli_test=tail(itaHoli,24*7)
```

```{r}
ita.rarima=auto.arima(itaLoad_train,xreg=itaHoli_train)
ita.rarima.for=forecast(ita.rarima,xreg=itaHoli_test)
ita.fc2=as.vector(ita.rarima.for$mean)
```

```{r}
autoplot(ita.rarima.for$mean,color='blue')+
  autolayer(itaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
ita.fore.comb=(ita.fc1+ita.fc2)/2
```

```{r, warning=FALSE}
itaLoad_test=tail(itaLoad,24*7)
itaLoad_test=as.vector(itaLoad_test)

fore=tibble(ID=1:168,fc1=ita.fc1,fc2=ita.fc2,Comb=ita.fore.comb,Actual=itaLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
ita.fore.comb=ts(ita.fore.comb,frequency = 24)
itaLoad_test=ts(itaLoad_test,frequency = 24)

autoplot(ita.fore.comb,color='blue')+
  autolayer(itaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
ita.sna=snaive(itaLoad_test,h=24*7)

MAE=accuracy(ita.fore.comb,itaLoad_test)[3]
  
RelMAE=accuracy(ita.fore.comb,itaLoad_test)[3]/accuracy(as.vector(ita.sna$mean),as.vector(itaLoad_test))[3]

sMAPE=mean(200*(abs(itaLoad_test-ita.fore.comb)/(itaLoad_test+ita.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# ita.train.stlm=tail(head(itaLoad1,length(itaLoad1)-24*7),24*7*4.25)
# 
# ita.stlm=ita.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# ita.fc1=as.vector(ita.stlm$mean)
```

```{r}
itaLoad_train=tail(head(itaLoad,length(itaLoad)-24*7),24*7*4.25*12)
itaTem_train=tail(head(itaTem,length(itaTem)-24*7),24*7*4.25*12)
itaTem_test=tail(itaTem,24*7)
```

```{r}
ita.rarima=auto.arima(itaLoad_train,xreg=itaTem_train)
ita.rarima.for=forecast(ita.rarima,xreg=itaTem_test)
ita.fc3=as.vector(ita.rarima.for$mean)
```

```{r}
ita.tbats.train=tail(head(itaLoad1,length(itaLoad1)-24*7),24*7*4.25)
ita.tbats=ita.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
ita.tbats.fore=forecast(ita.tbats,h=24*7)
ita.fc4=as.vector(ita.tbats.fore$mean)
```

```{r}
ita.ets.train=tail(head(itaLoad,length(itaLoad)-24*7),24*7*4.25*3)
ita.ets=ets(ita.ets.train,lambda = 0)
ita.fc5=as.vector(forecast(ita.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=ita.fc1,fc2=ita.fc4,fc3=ita.fc2,fc4=ita.fc3,fc5=ita.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#ita.fore.comb=rowMeans(fore)

ita.fore.comb=vector()

for (i in 1:168){
  ita.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
itaLoad_test=tail(itaLoad,24*7)
itaLoad_test=as.vector(itaLoad_test)

fore=tibble(ID=1:168,fc1=ita.fc1,fc2=ita.fc4,fc3=ita.fc2,fc4=ita.fc3,fc5=ita.fc5,Comb=ita.fore.comb,Actual=itaLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.text.y=element_text(size=9))
```

```{r}
ita.fore.comb=ts(ita.fore.comb,frequency = 24)
itaLoad_test=ts(itaLoad_test,frequency = 24)

autoplot(ita.fore.comb,color='blue')+
  autolayer(itaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
ita.sna=snaive(itaLoad_test,h=24*7)

MAE=accuracy(ita.fore.comb,itaLoad_test)[3]
  
RelMAE=accuracy(ita.fore.comb,itaLoad_test)[3]/accuracy(as.vector(ita.sna$mean),as.vector(itaLoad_test))[3]

sMAPE=mean(200*(abs(itaLoad_test-ita.fore.comb)/(itaLoad_test+ita.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  itaLoad_test=head(tail(itaLoad,24*7*i),24*7)
  itaLoad_test=as.vector(itaLoad_test)
  
  itaLoad_train1=tail(head(itaLoad1,length(itaLoad1)-24*7*i),24*7*4.25) 
  
  itaLoad_train2=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*4.25)
  
  itaLoad_train3=tail(head(itaLoad1,length(itaLoad1)-24*7*i),24*7*4.25*12)
  
  itaLoad_train4=tail(head(itaLoad,length(itaLoad)-24*7*i),24*7*4.25*3)
  
  ita.stlm=itaLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(ita.stlm$mean)
  
  ita.tbats=itaLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(ita.tbats,h=24*7)$mean)
  
  ita.ets=ets(itaLoad_train4,lambda = 0)
  fc3=as.vector(forecast(ita.ets,h=24*7)$mean)
  
  ita.mapa=mapaest(itaLoad_train2,paral=2)
  ita.mapa.for=mapafor(itaLoad_train2,ita.mapa,fh=24*7,outplot=0)
  fc4=as.vector(ita.mapa.for$outfor)
  
  ita.sna=snaive(itaLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,itaLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,itaLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,itaLoad_test)[3]/accuracy(ita.sna$mean,itaLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(itaLoad_test-fore_comb1)/(itaLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(itaLoad_test-fore_comb2)/(itaLoad_test+fore_comb2)))

}

ita.comb.maes=colMeans(MAEs,na.rm=T)
ita.comb.relmaes=colMeans(RelMAEs,na.rm=T)
ita.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
ita.comb.maes
ita.comb.relmaes
ita.comb.smapes
```

```{r}
ita.train.mapa=tail(head(itaLoad,length(itaLoad)-24*7),24*7*4.25)
ita.mapa=mapaest(ita.train.mapa,paral=2)

ita.mapa.for=mapafor(ita.train.mapa,ita.mapa,fh=24*7,outplot=1)
ita.fc6=ita.mapa.for$outfor
```

```{r}
itaLoad_test=ts(as.vector(tail(itaLoad,24*7)),frequency = 24)

autoplot(ts(ita.fc6,frequency = 24),color='blue')+
  autolayer(itaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
ita.fore.comb=0.4*ita.fc1+0.2*ita.fc4+0.2*ita.fc5+0.2*ita.fc6
```

```{r, warning=FALSE}
itaLoad_test=tail(itaLoad,24*7)
itaLoad_test=as.vector(itaLoad_test)

fore=tibble(ID=1:168,fc1=ita.fc1,fc2=ita.fc4,fc3=ita.fc5,fc4=ita.fc6,Comb=ita.fore.comb,Actual=itaLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
ita.fore.comb=ts(ita.fore.comb,frequency = 24)
itaLoad_test=ts(itaLoad_test,frequency = 24)

autoplot(ita.fore.comb,color='blue')+
  autolayer(itaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
ita.sna=snaive(itaLoad_test,h=24*7)

MAE=accuracy(ita.fore.comb,itaLoad_test)[3]
  
RelMAE=accuracy(ita.fore.comb,itaLoad_test)[3]/accuracy(as.vector(ita.sna$mean),as.vector(itaLoad_test))[3]

sMAPE=mean(200*(abs(itaLoad_test-ita.fore.comb)/(itaLoad_test+ita.fore.comb)))

MAE
RelMAE
sMAPE
```

# Poland

## Decomposition

```{r}
polLoad1=msts(pol$ActualTotalLoad,seasonal.periods = c(24,24*7))
polLoad1=na_ma(polLoad1)
polLoad2=msts(pol$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
polLoad2=na_ma(polLoad2)

polLoad=ts(pol$ActualTotalLoad,frequency = 24)
polLoad=na_ma(polLoad)
```

```{r}
length(as.vector(tsoutliers(polLoad)$index))/length(polLoad)
```

```{r}
out=tsoutliers(polLoad1)

for (o in out$index){
  polLoad1[o]=NA
}

out=tsoutliers(polLoad2)

for (o in out$index){
  polLoad2[o]=NA
}

out=tsoutliers(polLoad)

for (o in out$index){
  polLoad[o]=NA
}
```

```{r}
skimr::skim(polLoad1)
polLoad1=na_ma(polLoad1)
polLoad2=na_ma(polLoad2)
polLoad=na_ma(polLoad)
```


```{r}
polLoad_train2=tail(head(polLoad1,length(polLoad1)-24*7),24*7*4.25) #1month

polLoad_train5=tail(head(polLoad2,length(polLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
polLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
polLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  polLoad_test1=head(tail(polLoad1,24*7*i),24*7) #2week,1month
  polLoad_test2=head(tail(polLoad2,24*7*i),24*7) #3month,6month,1year
  
  polLoad_train1=tail(head(polLoad1,length(polLoad1)-24*7*i),24*7*2+1) #2week
  polLoad_train2=tail(head(polLoad1,length(polLoad1)-24*7*i),24*7*4.25) #1month
  polLoad_train3=tail(head(polLoad2,length(polLoad2)-24*7*i),24*7*4.25*3) #3month
  polLoad_train4=tail(head(polLoad2,length(polLoad2)-24*7*i),24*7*4.25*6) #6month
  polLoad_train5=tail(head(polLoad2,length(polLoad2)-24*7*i),24*7*4.25*12) #1year
  
  pol.stlm1=polLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  pol.stlm2=polLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  pol.stlm3=polLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  pol.stlm4=polLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  pol.stlm5=polLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  pol.sna1=snaive(polLoad_train1,h=24*7)
  pol.sna2=snaive(polLoad_train2,h=24*7)
  pol.sna3=snaive(polLoad_train3,h=24*7)
  pol.sna4=snaive(polLoad_train4,h=24*7)
  pol.sna5=snaive(polLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(pol.stlm1$mean,polLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(pol.stlm2$mean,polLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(pol.stlm3$mean,polLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(pol.stlm4$mean,polLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(pol.stlm5$mean,polLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(pol.stlm1$mean,polLoad_test1)[3]/accuracy(pol.sna1$mean,polLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(pol.stlm2$mean,polLoad_test1)[3]/accuracy(pol.sna2$mean,polLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(pol.stlm3$mean,polLoad_test2)[3]/accuracy(pol.sna3$mean,polLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(pol.stlm4$mean,polLoad_test2)[3]/accuracy(pol.sna4$mean,polLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(pol.stlm5$mean,polLoad_test2)[3]/accuracy(pol.sna5$mean,polLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(polLoad_test1-pol.stlm1$mean)/(polLoad_test1+pol.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(polLoad_test1-pol.stlm2$mean)/(polLoad_test1+pol.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(polLoad_test2-pol.stlm3$mean)/(polLoad_test2+pol.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(polLoad_test2-pol.stlm4$mean)/(polLoad_test2+pol.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(polLoad_test2-pol.stlm5$mean)/(polLoad_test2+pol.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  polLoad_test1=head(tail(polLoad1,24*7*i),24*7) #2week,1month
  
  polLoad_train1=tail(head(polLoad1,length(polLoad1)-24*7*i),24*7*2+1) #2week
  polLoad_train2=tail(head(polLoad1,length(polLoad1)-24*7*i),24*7*4.25) #1month
  
  
  pol.tbats1=polLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  pol.tbats.fore1=forecast(pol.tbats1,h=24*7)
  
  pol.tbats2=polLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  pol.tbats.fore2=forecast(pol.tbats2,h=24*7)
  
  
  pol.sna1=snaive(polLoad_train1,h=24*7)
  pol.sna2=snaive(polLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(pol.tbats.fore1$mean,polLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(pol.tbats.fore2$mean,polLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(pol.tbats.fore1$mean,polLoad_test1)[3]/accuracy(pol.sna1$mean,polLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(pol.tbats.fore2$mean,polLoad_test1)[3]/accuracy(pol.sna2$mean,polLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(polLoad_test1-pol.tbats.fore1$mean)/(polLoad_test1+pol.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(polLoad_test1-pol.tbats.fore2$mean)/(polLoad_test1+pol.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  polLoad_test=head(tail(polLoad,24*7*i),24*7)
  polLoad_train1=tail(head(polLoad,length(polLoad)-24*7*i),24*7*2+1)
  polLoad_train2=tail(head(polLoad,length(polLoad)-24*7*i),24*7*4.25)
  polLoad_train3=tail(head(polLoad,length(polLoad)-24*7*i),24*7*4.25*3)
  polLoad_train4=tail(head(polLoad,length(polLoad)-24*7*i),24*7*4.25*6)
  polLoad_train5=tail(head(polLoad,length(polLoad)-24*7*i),24*7*4.25*12)
  
  pol.ets1=ets(polLoad_train1,lambda = 0)
  fc1=forecast(pol.ets1,h=24*7)$mean
  
  pol.ets2=ets(polLoad_train2,lambda = 0)
  fc2=forecast(pol.ets2,h=24*7)$mean
  
  pol.ets3=ets(polLoad_train3,lambda = 0)
  fc3=forecast(pol.ets3,h=24*7)$mean
  
  pol.ets4=ets(polLoad_train4,lambda = 0)
  fc4=forecast(pol.ets4,h=24*7)$mean
  
  pol.ets5=ets(polLoad_train5,lambda = 0)
  fc5=forecast(pol.ets5,h=24*7)$mean
  
  
  pol.sna=snaive(polLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,polLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,polLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,polLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,polLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,polLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(polLoad_test-fc1)/(polLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(polLoad_test-fc2)/(polLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(polLoad_test-fc3)/(polLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(polLoad_test-fc4)/(polLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(polLoad_test-fc5)/(polLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
polweather=read_csv("pol_weather.csv")
polweather$TimeUTC=dmy_hm(polweather$TimeUTC)
polweather$T=as.double(polweather$T)
pol=left_join(pol,polweather,by="TimeUTC")

polholiday=read_csv("pol_holiday.csv")
polholiday$TimeUTC=dmy_hm(polholiday$TimeUTC)
polholiday$Holiday=as.integer(polholiday$Holiday)
pol=left_join(pol,polholiday,by="TimeUTC")
```

```{r}
polTem=ts(pol$T,frequency=24)
polTem=na_ma(polTem)
polHoli=ts(pol$Holiday,frequency=24)
```

## Final forecasts

### Round 1

```{r}
pol.train.stlm=tail(head(polLoad1,length(polLoad1)-24*7),24*7*4.25*12)
polLoad_test=tail(polLoad,24*7)

pol.stlm=pol.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

pol.fc1=as.vector(pol.stlm$mean)
```

```{r}
polLoad_train=tail(head(polLoad,length(polLoad)-24*7),24*7*4.25*12)
polHoli_train=tail(head(polHoli,length(polHoli)-24*7),24*7*4.25*12)
polHoli_train=na_ma(polHoli_train)
polHoli_test=tail(polHoli,24*7)
polHoli_test=na_ma(polHoli_test)
```

```{r}
pol.rarima=auto.arima(polLoad_train,xreg=polHoli_train)
pol.rarima.for=forecast(pol.rarima,xreg=polHoli_test)
pol.fc2=as.vector(pol.rarima.for$mean)
```

```{r}
autoplot(pol.rarima.for$mean,color='blue')+
  autolayer(polLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
pol.fore.comb=(pol.fc1+pol.fc2)/2
```

```{r, warning=FALSE}
polLoad_test=tail(polLoad,24*7)
polLoad_test=as.vector(polLoad_test)

fore=tibble(ID=1:168,fc1=pol.fc1,fc2=pol.fc2,Comb=pol.fore.comb,Actual=polLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
pol.fore.comb=ts(pol.fore.comb,frequency = 24)
polLoad_test=ts(polLoad_test,frequency = 24)

autoplot(pol.fore.comb,color='blue')+
  autolayer(polLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
pol.sna=snaive(polLoad_test,h=24*7)

MAE=accuracy(pol.fore.comb,polLoad_test)[3]
  
RelMAE=accuracy(pol.fore.comb,polLoad_test)[3]/accuracy(as.vector(pol.sna$mean),as.vector(polLoad_test))[3]

sMAPE=mean(200*(abs(polLoad_test-pol.fore.comb)/(polLoad_test+pol.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# pol.train.stlm=tail(head(polLoad1,length(polLoad1)-24*7),24*7*4.25)
# 
# pol.stlm=pol.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# pol.fc1=as.vector(pol.stlm$mean)
```

```{r}
polLoad_train=tail(head(polLoad,length(polLoad)-24*7),24*7*4.25*12)
polTem_train=tail(head(polTem,length(polTem)-24*7),24*7*4.25*12)
polTem_test=tail(polTem,24*7)
```

```{r}
pol.rarima=auto.arima(polLoad_train,xreg=polTem_train)
pol.rarima.for=forecast(pol.rarima,xreg=polTem_test)
pol.fc3=as.vector(pol.rarima.for$mean)
```

```{r}
pol.tbats.train=tail(head(polLoad1,length(polLoad1)-24*7),24*7*4.25)
pol.tbats=pol.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
pol.tbats.fore=forecast(pol.tbats,h=24*7)
pol.fc4=as.vector(pol.tbats.fore$mean)
```

```{r}
pol.ets.train=tail(head(polLoad,length(polLoad)-24*7),24*7*2+1)
pol.ets=ets(pol.ets.train,lambda = 0)
pol.fc5=as.vector(forecast(pol.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=pol.fc1,fc2=pol.fc4,fc3=pol.fc2,fc4=pol.fc3,fc5=pol.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#pol.fore.comb=rowMeans(fore)

pol.fore.comb=vector()

for (i in 1:168){
  pol.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
polLoad_test=tail(polLoad,24*7)
polLoad_test=as.vector(polLoad_test)

fore=tibble(ID=1:168,fc1=pol.fc1,fc2=pol.fc4,fc3=pol.fc2,fc4=pol.fc3,fc5=pol.fc5,Comb=pol.fore.comb,Actual=polLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.text.y=element_text(size=9))
```

```{r}
pol.fore.comb=ts(pol.fore.comb,frequency = 24)
polLoad_test=ts(polLoad_test,frequency = 24)

autoplot(pol.fore.comb,color='blue')+
  autolayer(polLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
pol.sna=snaive(polLoad_test,h=24*7)

MAE=accuracy(pol.fore.comb,polLoad_test)[3]
  
RelMAE=accuracy(pol.fore.comb,polLoad_test)[3]/accuracy(as.vector(pol.sna$mean),as.vector(polLoad_test))[3]

sMAPE=mean(200*(abs(polLoad_test-pol.fore.comb)/(polLoad_test+pol.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  polLoad_test=head(tail(polLoad,24*7*i),24*7)
  polLoad_test=as.vector(polLoad_test)
  
  polLoad_train1=tail(head(polLoad1,length(polLoad1)-24*7*i),24*7*4.25) 
  
  polLoad_train2=tail(head(polLoad,length(polLoad)-24*7*i),24*7*4.25)
  
  polLoad_train3=tail(head(polLoad1,length(polLoad1)-24*7*i),24*7*4.25*12)
  
  polLoad_train4=tail(head(polLoad,length(polLoad)-24*7*i),24*7*4.25*3)
  
  pol.stlm=polLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(pol.stlm$mean)
  
  pol.tbats=polLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(pol.tbats,h=24*7)$mean)
  
  pol.ets=ets(polLoad_train4,lambda = 0)
  fc3=as.vector(forecast(pol.ets,h=24*7)$mean)
  
  pol.mapa=mapaest(polLoad_train2,paral=2)
  pol.mapa.for=mapafor(polLoad_train2,pol.mapa,fh=24*7,outplot=0)
  fc4=as.vector(pol.mapa.for$outfor)
  
  pol.sna=snaive(polLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,polLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,polLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,polLoad_test)[3]/accuracy(pol.sna$mean,polLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(polLoad_test-fore_comb1)/(polLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(polLoad_test-fore_comb2)/(polLoad_test+fore_comb2)))

}

pol.comb.maes=colMeans(MAEs,na.rm=T)
pol.comb.relmaes=colMeans(RelMAEs,na.rm=T)
pol.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
pol.comb.maes
pol.comb.relmaes
pol.comb.smapes
```

```{r}
pol.train.mapa=tail(head(polLoad,length(polLoad)-24*7),24*7*4.25)
pol.mapa=mapaest(pol.train.mapa,paral=2)

pol.mapa.for=mapafor(pol.train.mapa,pol.mapa,fh=24*7,outplot=1)
pol.fc6=pol.mapa.for$outfor
```

```{r}
polLoad_test=ts(as.vector(tail(polLoad,24*7)),frequency = 24)

autoplot(ts(pol.fc6,frequency = 24),color='blue')+
  autolayer(polLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
pol.fore.comb=0.4*pol.fc1+0.2*pol.fc4+0.2*pol.fc5+0.2*pol.fc6
```

```{r, warning=FALSE}
polLoad_test=tail(polLoad,24*7)
polLoad_test=as.vector(polLoad_test)

fore=tibble(ID=1:168,fc1=pol.fc1,fc2=pol.fc4,fc3=pol.fc5,fc4=pol.fc6,Comb=pol.fore.comb,Actual=polLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
pol.fore.comb=ts(pol.fore.comb,frequency = 24)
polLoad_test=ts(polLoad_test,frequency = 24)

autoplot(pol.fore.comb,color='blue')+
  autolayer(polLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
pol.sna=snaive(polLoad_test,h=24*7)

MAE=accuracy(pol.fore.comb,polLoad_test)[3]
  
RelMAE=accuracy(pol.fore.comb,polLoad_test)[3]/accuracy(as.vector(pol.sna$mean),as.vector(polLoad_test))[3]

sMAPE=mean(200*(abs(polLoad_test-pol.fore.comb)/(polLoad_test+pol.fore.comb)))

MAE
RelMAE
sMAPE
```

# Romania

## Decomposition

```{r}
romLoad1=msts(rom$ActualTotalLoad,seasonal.periods = c(24,24*7))
romLoad1=na_ma(romLoad1)
romLoad2=msts(rom$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
romLoad2=na_ma(romLoad2)

romLoad=ts(rom$ActualTotalLoad,frequency = 24)
romLoad=na_ma(romLoad)
```

```{r}
length(as.vector(tsoutliers(romLoad)$index))/length(romLoad)
```

```{r}
out=tsoutliers(romLoad1)

for (o in out$index){
  romLoad1[o]=NA
}

out=tsoutliers(romLoad2)

for (o in out$index){
  romLoad2[o]=NA
}

out=tsoutliers(romLoad)

for (o in out$index){
  romLoad[o]=NA
}
```

```{r}
skimr::skim(romLoad1)
romLoad1=na_ma(romLoad1)
romLoad2=na_ma(romLoad2)
romLoad=na_ma(romLoad)
```


```{r}
romLoad_train2=tail(head(romLoad1,length(romLoad1)-24*7),24*7*4.25) #1month

romLoad_train5=tail(head(romLoad2,length(romLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
romLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
romLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  romLoad_test1=head(tail(romLoad1,24*7*i),24*7) #2week,1month
  romLoad_test2=head(tail(romLoad2,24*7*i),24*7) #3month,6month,1year
  
  romLoad_train1=tail(head(romLoad1,length(romLoad1)-24*7*i),24*7*2+1) #2week
  romLoad_train2=tail(head(romLoad1,length(romLoad1)-24*7*i),24*7*4.25) #1month
  romLoad_train3=tail(head(romLoad2,length(romLoad2)-24*7*i),24*7*4.25*3) #3month
  romLoad_train4=tail(head(romLoad2,length(romLoad2)-24*7*i),24*7*4.25*6) #6month
  romLoad_train5=tail(head(romLoad2,length(romLoad2)-24*7*i),24*7*4.25*12) #1year
  
  rom.stlm1=romLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  rom.stlm2=romLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  rom.stlm3=romLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  rom.stlm4=romLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  rom.stlm5=romLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  rom.sna1=snaive(romLoad_train1,h=24*7)
  rom.sna2=snaive(romLoad_train2,h=24*7)
  rom.sna3=snaive(romLoad_train3,h=24*7)
  rom.sna4=snaive(romLoad_train4,h=24*7)
  rom.sna5=snaive(romLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(rom.stlm1$mean,romLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(rom.stlm2$mean,romLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(rom.stlm3$mean,romLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(rom.stlm4$mean,romLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(rom.stlm5$mean,romLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(rom.stlm1$mean,romLoad_test1)[3]/accuracy(rom.sna1$mean,romLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(rom.stlm2$mean,romLoad_test1)[3]/accuracy(rom.sna2$mean,romLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(rom.stlm3$mean,romLoad_test2)[3]/accuracy(rom.sna3$mean,romLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(rom.stlm4$mean,romLoad_test2)[3]/accuracy(rom.sna4$mean,romLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(rom.stlm5$mean,romLoad_test2)[3]/accuracy(rom.sna5$mean,romLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(romLoad_test1-rom.stlm1$mean)/(romLoad_test1+rom.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(romLoad_test1-rom.stlm2$mean)/(romLoad_test1+rom.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(romLoad_test2-rom.stlm3$mean)/(romLoad_test2+rom.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(romLoad_test2-rom.stlm4$mean)/(romLoad_test2+rom.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(romLoad_test2-rom.stlm5$mean)/(romLoad_test2+rom.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  romLoad_test1=head(tail(romLoad1,24*7*i),24*7) #2week,1month
  
  romLoad_train1=tail(head(romLoad1,length(romLoad1)-24*7*i),24*7*2+1) #2week
  romLoad_train2=tail(head(romLoad1,length(romLoad1)-24*7*i),24*7*4.25) #1month
  
  
  rom.tbats1=romLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  rom.tbats.fore1=forecast(rom.tbats1,h=24*7)
  
  rom.tbats2=romLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  rom.tbats.fore2=forecast(rom.tbats2,h=24*7)
  
  
  rom.sna1=snaive(romLoad_train1,h=24*7)
  rom.sna2=snaive(romLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(rom.tbats.fore1$mean,romLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(rom.tbats.fore2$mean,romLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(rom.tbats.fore1$mean,romLoad_test1)[3]/accuracy(rom.sna1$mean,romLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(rom.tbats.fore2$mean,romLoad_test1)[3]/accuracy(rom.sna2$mean,romLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(romLoad_test1-rom.tbats.fore1$mean)/(romLoad_test1+rom.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(romLoad_test1-rom.tbats.fore2$mean)/(romLoad_test1+rom.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  romLoad_test=head(tail(romLoad,24*7*i),24*7)
  romLoad_train1=tail(head(romLoad,length(romLoad)-24*7*i),24*7*2+1)
  romLoad_train2=tail(head(romLoad,length(romLoad)-24*7*i),24*7*4.25)
  romLoad_train3=tail(head(romLoad,length(romLoad)-24*7*i),24*7*4.25*3)
  romLoad_train4=tail(head(romLoad,length(romLoad)-24*7*i),24*7*4.25*6)
  romLoad_train5=tail(head(romLoad,length(romLoad)-24*7*i),24*7*4.25*12)
  
  rom.ets1=ets(romLoad_train1,lambda = 0)
  fc1=forecast(rom.ets1,h=24*7)$mean
  
  rom.ets2=ets(romLoad_train2,lambda = 0)
  fc2=forecast(rom.ets2,h=24*7)$mean
  
  rom.ets3=ets(romLoad_train3,lambda = 0)
  fc3=forecast(rom.ets3,h=24*7)$mean
  
  rom.ets4=ets(romLoad_train4,lambda = 0)
  fc4=forecast(rom.ets4,h=24*7)$mean
  
  rom.ets5=ets(romLoad_train5,lambda = 0)
  fc5=forecast(rom.ets5,h=24*7)$mean
  
  
  rom.sna=snaive(romLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,romLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,romLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,romLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,romLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,romLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(romLoad_test-fc1)/(romLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(romLoad_test-fc2)/(romLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(romLoad_test-fc3)/(romLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(romLoad_test-fc4)/(romLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(romLoad_test-fc5)/(romLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
romweather=read_csv("rom_weather.csv")
romweather$TimeUTC=dmy_hm(romweather$TimeUTC)
romweather$T=as.double(romweather$T)
rom=left_join(rom,romweather,by="TimeUTC")

romholiday=read_csv("rom_holiday.csv")
romholiday$TimeUTC=dmy_hm(romholiday$TimeUTC)
romholiday$Holiday=as.integer(romholiday$Holiday)
rom=left_join(rom,romholiday,by="TimeUTC")
```

```{r}
romTem=ts(rom$T,frequency=24)
romTem=na_ma(romTem)
romHoli=ts(rom$Holiday,frequency=24)
```

## Final forecasts

### Round 1

```{r}
rom.train.stlm=tail(head(romLoad1,length(romLoad1)-24*7),24*7*4.25*12)
romLoad_test=tail(romLoad,24*7)

rom.stlm=rom.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

rom.fc1=as.vector(rom.stlm$mean)
```

```{r}
romLoad_train=tail(head(romLoad,length(romLoad)-24*7),24*7*4.25*12)
romHoli_train=tail(head(romHoli,length(romHoli)-24*7),24*7*4.25*12)
romHoli_train=na_ma(romHoli_train)
romHoli_test=tail(romHoli,24*7)
romHoli_test=na_ma(romHoli_test)
```

```{r}
rom.rarima=auto.arima(romLoad_train,xreg=romHoli_train)
rom.rarima.for=forecast(rom.rarima,xreg=romHoli_test)
rom.fc2=as.vector(rom.rarima.for$mean)
```

```{r}
autoplot(rom.rarima.for$mean,color='blue')+
  autolayer(romLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
rom.fore.comb=(rom.fc1+rom.fc2)/2
```

```{r, warning=FALSE}
romLoad_test=tail(romLoad,24*7)
romLoad_test=as.vector(romLoad_test)

fore=tibble(ID=1:168,fc1=rom.fc1,fc2=rom.fc2,Comb=rom.fore.comb,Actual=romLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
rom.fore.comb=ts(rom.fore.comb,frequency = 24)
romLoad_test=ts(romLoad_test,frequency = 24)

autoplot(rom.fore.comb,color='blue')+
  autolayer(romLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
rom.sna=snaive(romLoad_test,h=24*7)

MAE=accuracy(rom.fore.comb,romLoad_test)[3]
  
RelMAE=accuracy(rom.fore.comb,romLoad_test)[3]/accuracy(as.vector(rom.sna$mean),as.vector(romLoad_test))[3]

sMAPE=mean(200*(abs(romLoad_test-rom.fore.comb)/(romLoad_test+rom.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# rom.train.stlm=tail(head(romLoad1,length(romLoad1)-24*7),24*7*4.25)
# 
# rom.stlm=rom.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# rom.fc1=as.vector(rom.stlm$mean)
```

```{r}
romLoad_train=tail(head(romLoad,length(romLoad)-24*7),24*7*4.25*12)
romTem_train=tail(head(romTem,length(romTem)-24*7),24*7*4.25*12)
romTem_test=tail(romTem,24*7)
```

```{r}
rom.rarima=auto.arima(romLoad_train,xreg=romTem_train)
rom.rarima.for=forecast(rom.rarima,xreg=romTem_test)
rom.fc3=as.vector(rom.rarima.for$mean)
```

```{r}
rom.tbats.train=tail(head(romLoad1,length(romLoad1)-24*7),24*7*4.25)
rom.tbats=rom.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
rom.tbats.fore=forecast(rom.tbats,h=24*7)
rom.fc4=as.vector(rom.tbats.fore$mean)
```

```{r}
rom.ets.train=tail(head(romLoad,length(romLoad)-24*7),24*7*4.25*6)
rom.ets=ets(rom.ets.train,lambda = 0)
rom.fc5=as.vector(forecast(rom.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=rom.fc1,fc2=rom.fc4,fc3=rom.fc2,fc4=rom.fc3,fc5=rom.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#rom.fore.comb=rowMeans(fore)

rom.fore.comb=vector()

for (i in 1:168){
  rom.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
romLoad_test=tail(romLoad,24*7)
romLoad_test=as.vector(romLoad_test)

fore=tibble(ID=1:168,fc1=rom.fc1,fc2=rom.fc4,fc3=rom.fc2,fc4=rom.fc3,fc5=rom.fc5,Comb=rom.fore.comb,Actual=romLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.text.y=element_text(size=9))
```

```{r}
rom.fore.comb=ts(rom.fore.comb,frequency = 24)
romLoad_test=ts(romLoad_test,frequency = 24)

autoplot(rom.fore.comb,color='blue')+
  autolayer(romLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
rom.sna=snaive(romLoad_test,h=24*7)

MAE=accuracy(rom.fore.comb,romLoad_test)[3]
  
RelMAE=accuracy(rom.fore.comb,romLoad_test)[3]/accuracy(as.vector(rom.sna$mean),as.vector(romLoad_test))[3]

sMAPE=mean(200*(abs(romLoad_test-rom.fore.comb)/(romLoad_test+rom.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  romLoad_test=head(tail(romLoad,24*7*i),24*7)
  romLoad_test=as.vector(romLoad_test)
  
  romLoad_train1=tail(head(romLoad1,length(romLoad1)-24*7*i),24*7*4.25) 
  
  romLoad_train2=tail(head(romLoad,length(romLoad)-24*7*i),24*7*4.25)
  
  romLoad_train3=tail(head(romLoad1,length(romLoad1)-24*7*i),24*7*4.25*12)
  
  romLoad_train4=tail(head(romLoad,length(romLoad)-24*7*i),24*7*4.25*6)
  
  rom.stlm=romLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(rom.stlm$mean)
  
  rom.tbats=romLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(rom.tbats,h=24*7)$mean)
  
  rom.ets=ets(romLoad_train4,lambda = 0)
  fc3=as.vector(forecast(rom.ets,h=24*7)$mean)
  
  rom.mapa=mapaest(romLoad_train2,paral=2)
  rom.mapa.for=mapafor(romLoad_train2,rom.mapa,fh=24*7,outplot=0)
  fc4=as.vector(rom.mapa.for$outfor)
  
  rom.sna=snaive(romLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,romLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,romLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,romLoad_test)[3]/accuracy(rom.sna$mean,romLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(romLoad_test-fore_comb1)/(romLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(romLoad_test-fore_comb2)/(romLoad_test+fore_comb2)))

}

rom.comb.maes=colMeans(MAEs,na.rm=T)
rom.comb.relmaes=colMeans(RelMAEs,na.rm=T)
rom.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
rom.comb.maes
rom.comb.relmaes
rom.comb.smapes
```

```{r}
rom.train.mapa=tail(head(romLoad,length(romLoad)-24*7),24*7*4.25)
rom.mapa=mapaest(rom.train.mapa,paral=2)

rom.mapa.for=mapafor(rom.train.mapa,rom.mapa,fh=24*7,outplot=1)
rom.fc6=rom.mapa.for$outfor
```

```{r}
romLoad_test=ts(as.vector(tail(romLoad,24*7)),frequency = 24)

autoplot(ts(rom.fc6,frequency = 24),color='blue')+
  autolayer(romLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
rom.fore.comb=0.4*rom.fc1+0.2*rom.fc4+0.2*rom.fc5+0.2*rom.fc6
```

```{r, warning=FALSE}
romLoad_test=tail(romLoad,24*7)
romLoad_test=as.vector(romLoad_test)

fore=tibble(ID=1:168,fc1=rom.fc1,fc2=rom.fc4,fc3=rom.fc5,fc4=rom.fc6,Comb=rom.fore.comb,Actual=romLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
rom.fore.comb=ts(rom.fore.comb,frequency = 24)
romLoad_test=ts(romLoad_test,frequency = 24)

autoplot(rom.fore.comb,color='blue')+
  autolayer(romLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
rom.sna=snaive(romLoad_test,h=24*7)

MAE=accuracy(rom.fore.comb,romLoad_test)[3]
  
RelMAE=accuracy(rom.fore.comb,romLoad_test)[3]/accuracy(as.vector(rom.sna$mean),as.vector(romLoad_test))[3]

sMAPE=mean(200*(abs(romLoad_test-rom.fore.comb)/(romLoad_test+rom.fore.comb)))

MAE
RelMAE
sMAPE
```

# Spain

## Decomposition

```{r}
spaLoad1=msts(spa$ActualTotalLoad,seasonal.periods = c(24,24*7))
spaLoad1=na_ma(spaLoad1)
spaLoad2=msts(spa$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
spaLoad2=na_ma(spaLoad2)

spaLoad=ts(spa$ActualTotalLoad,frequency = 24)
spaLoad=na_ma(spaLoad)
```

```{r}
length(as.vector(tsoutliers(spaLoad)$index))/length(spaLoad)
```

```{r}
out=tsoutliers(spaLoad1)

for (o in out$index){
  spaLoad1[o]=NA
}

out=tsoutliers(spaLoad2)

for (o in out$index){
  spaLoad2[o]=NA
}

out=tsoutliers(spaLoad)

for (o in out$index){
  spaLoad[o]=NA
}
```

```{r}
skimr::skim(spaLoad1)
spaLoad1=na_ma(spaLoad1)
spaLoad2=na_ma(spaLoad2)
spaLoad=na_ma(spaLoad)
```


```{r}
spaLoad_train2=tail(head(spaLoad1,length(spaLoad1)-24*7),24*7*4.25) #1month

spaLoad_train5=tail(head(spaLoad2,length(spaLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
spaLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
spaLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  spaLoad_test1=head(tail(spaLoad1,24*7*i),24*7) #2week,1month
  spaLoad_test2=head(tail(spaLoad2,24*7*i),24*7) #3month,6month,1year
  
  spaLoad_train1=tail(head(spaLoad1,length(spaLoad1)-24*7*i),24*7*2+1) #2week
  spaLoad_train2=tail(head(spaLoad1,length(spaLoad1)-24*7*i),24*7*4.25) #1month
  spaLoad_train3=tail(head(spaLoad2,length(spaLoad2)-24*7*i),24*7*4.25*3) #3month
  spaLoad_train4=tail(head(spaLoad2,length(spaLoad2)-24*7*i),24*7*4.25*6) #6month
  spaLoad_train5=tail(head(spaLoad2,length(spaLoad2)-24*7*i),24*7*4.25*12) #1year
  
  spa.stlm1=spaLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  spa.stlm2=spaLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  spa.stlm3=spaLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  spa.stlm4=spaLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  spa.stlm5=spaLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  spa.sna1=snaive(spaLoad_train1,h=24*7)
  spa.sna2=snaive(spaLoad_train2,h=24*7)
  spa.sna3=snaive(spaLoad_train3,h=24*7)
  spa.sna4=snaive(spaLoad_train4,h=24*7)
  spa.sna5=snaive(spaLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(spa.stlm1$mean,spaLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(spa.stlm2$mean,spaLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(spa.stlm3$mean,spaLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(spa.stlm4$mean,spaLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(spa.stlm5$mean,spaLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(spa.stlm1$mean,spaLoad_test1)[3]/accuracy(spa.sna1$mean,spaLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(spa.stlm2$mean,spaLoad_test1)[3]/accuracy(spa.sna2$mean,spaLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(spa.stlm3$mean,spaLoad_test2)[3]/accuracy(spa.sna3$mean,spaLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(spa.stlm4$mean,spaLoad_test2)[3]/accuracy(spa.sna4$mean,spaLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(spa.stlm5$mean,spaLoad_test2)[3]/accuracy(spa.sna5$mean,spaLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(spaLoad_test1-spa.stlm1$mean)/(spaLoad_test1+spa.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(spaLoad_test1-spa.stlm2$mean)/(spaLoad_test1+spa.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(spaLoad_test2-spa.stlm3$mean)/(spaLoad_test2+spa.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(spaLoad_test2-spa.stlm4$mean)/(spaLoad_test2+spa.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(spaLoad_test2-spa.stlm5$mean)/(spaLoad_test2+spa.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  spaLoad_test1=head(tail(spaLoad1,24*7*i),24*7) #2week,1month
  
  spaLoad_train1=tail(head(spaLoad1,length(spaLoad1)-24*7*i),24*7*2+1) #2week
  spaLoad_train2=tail(head(spaLoad1,length(spaLoad1)-24*7*i),24*7*4.25) #1month
  
  
  spa.tbats1=spaLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  spa.tbats.fore1=forecast(spa.tbats1,h=24*7)
  
  spa.tbats2=spaLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  spa.tbats.fore2=forecast(spa.tbats2,h=24*7)
  
  
  spa.sna1=snaive(spaLoad_train1,h=24*7)
  spa.sna2=snaive(spaLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(spa.tbats.fore1$mean,spaLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(spa.tbats.fore2$mean,spaLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(spa.tbats.fore1$mean,spaLoad_test1)[3]/accuracy(spa.sna1$mean,spaLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(spa.tbats.fore2$mean,spaLoad_test1)[3]/accuracy(spa.sna2$mean,spaLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(spaLoad_test1-spa.tbats.fore1$mean)/(spaLoad_test1+spa.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(spaLoad_test1-spa.tbats.fore2$mean)/(spaLoad_test1+spa.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  spaLoad_test=head(tail(spaLoad,24*7*i),24*7)
  spaLoad_train1=tail(head(spaLoad,length(spaLoad)-24*7*i),24*7*2+1)
  spaLoad_train2=tail(head(spaLoad,length(spaLoad)-24*7*i),24*7*4.25)
  spaLoad_train3=tail(head(spaLoad,length(spaLoad)-24*7*i),24*7*4.25*3)
  spaLoad_train4=tail(head(spaLoad,length(spaLoad)-24*7*i),24*7*4.25*6)
  spaLoad_train5=tail(head(spaLoad,length(spaLoad)-24*7*i),24*7*4.25*12)
  
  spa.ets1=ets(spaLoad_train1,lambda = 0)
  fc1=forecast(spa.ets1,h=24*7)$mean
  
  spa.ets2=ets(spaLoad_train2,lambda = 0)
  fc2=forecast(spa.ets2,h=24*7)$mean
  
  spa.ets3=ets(spaLoad_train3,lambda = 0)
  fc3=forecast(spa.ets3,h=24*7)$mean
  
  spa.ets4=ets(spaLoad_train4,lambda = 0)
  fc4=forecast(spa.ets4,h=24*7)$mean
  
  spa.ets5=ets(spaLoad_train5,lambda = 0)
  fc5=forecast(spa.ets5,h=24*7)$mean
  
  
  spa.sna=snaive(spaLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,spaLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,spaLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,spaLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,spaLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,spaLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(spaLoad_test-fc1)/(spaLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(spaLoad_test-fc2)/(spaLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(spaLoad_test-fc3)/(spaLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(spaLoad_test-fc4)/(spaLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(spaLoad_test-fc5)/(spaLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
spaweather=read_csv("spa_weather.csv")
spaweather$TimeUTC=dmy_hm(spaweather$TimeUTC)
spaweather$T=as.double(spaweather$T)
spa=left_join(spa,spaweather,by="TimeUTC")

spaholiday=read_csv("spa_holiday.csv")
spaholiday$TimeUTC=dmy_hm(spaholiday$TimeUTC)
spaholiday$Holiday=as.integer(spaholiday$Holiday)
spa=left_join(spa,spaholiday,by="TimeUTC")
```

```{r}
spaTem=ts(spa$T,frequency=24)
spaTem=na_ma(spaTem)
spaHoli=ts(spa$Holiday,frequency=24)
```

## Final forecasts

### Round 1

```{r}
spa.train.stlm=tail(head(spaLoad1,length(spaLoad1)-24*7),24*7*4.25*12)
spaLoad_test=tail(spaLoad,24*7)

spa.stlm=spa.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

spa.fc1=as.vector(spa.stlm$mean)
```

```{r}
spaLoad_train=tail(head(spaLoad,length(spaLoad)-24*7),24*7*4.25*12)
spaHoli_train=tail(head(spaHoli,length(spaHoli)-24*7),24*7*4.25*12)
spaHoli_train=na_ma(spaHoli_train)
spaHoli_test=tail(spaHoli,24*7)
spaHoli_test=na_ma(spaHoli_test)
```

```{r}
spa.rarima=auto.arima(spaLoad_train,xreg=spaHoli_train)
spa.rarima.for=forecast(spa.rarima,xreg=spaHoli_test)
spa.fc2=as.vector(spa.rarima.for$mean)
```

```{r}
autoplot(spa.rarima.for$mean,color='blue')+
  autolayer(spaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
spa.fore.comb=(spa.fc1+spa.fc2)/2
```

```{r, warning=FALSE}
spaLoad_test=tail(spaLoad,24*7)
spaLoad_test=as.vector(spaLoad_test)

fore=tibble(ID=1:168,fc1=spa.fc1,fc2=spa.fc2,Comb=spa.fore.comb,Actual=spaLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
spa.fore.comb=ts(spa.fore.comb,frequency = 24)
spaLoad_test=ts(spaLoad_test,frequency = 24)

autoplot(spa.fore.comb,color='blue')+
  autolayer(spaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
spa.sna=snaive(spaLoad_test,h=24*7)

MAE=accuracy(spa.fore.comb,spaLoad_test)[3]
  
RelMAE=accuracy(spa.fore.comb,spaLoad_test)[3]/accuracy(as.vector(spa.sna$mean),as.vector(spaLoad_test))[3]

sMAPE=mean(200*(abs(spaLoad_test-spa.fore.comb)/(spaLoad_test+spa.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# spa.train.stlm=tail(head(spaLoad1,length(spaLoad1)-24*7),24*7*4.25)
# 
# spa.stlm=spa.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# spa.fc1=as.vector(spa.stlm$mean)
```

```{r}
spaLoad_train=tail(head(spaLoad,length(spaLoad)-24*7),24*7*4.25*12)
spaTem_train=tail(head(spaTem,length(spaTem)-24*7),24*7*4.25*12)
spaTem_test=tail(spaTem,24*7)
```

```{r}
spa.rarima=auto.arima(spaLoad_train,xreg=spaTem_train)
spa.rarima.for=forecast(spa.rarima,xreg=spaTem_test)
spa.fc3=as.vector(spa.rarima.for$mean)
```

```{r}
spa.tbats.train=tail(head(spaLoad1,length(spaLoad1)-24*7),24*7*4.25)
spa.tbats=spa.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
spa.tbats.fore=forecast(spa.tbats,h=24*7)
spa.fc4=as.vector(spa.tbats.fore$mean)
```

```{r}
spa.ets.train=tail(head(spaLoad,length(spaLoad)-24*7),24*7*4.25)
spa.ets=ets(spa.ets.train,lambda = 0)
spa.fc5=as.vector(forecast(spa.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=spa.fc1,fc2=spa.fc4,fc3=spa.fc2,fc4=spa.fc3,fc5=spa.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#spa.fore.comb=rowMeans(fore)

spa.fore.comb=vector()

for (i in 1:168){
  spa.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
spaLoad_test=tail(spaLoad,24*7)
spaLoad_test=as.vector(spaLoad_test)

fore=tibble(ID=1:168,fc1=spa.fc1,fc2=spa.fc4,fc3=spa.fc2,fc4=spa.fc3,fc5=spa.fc5,Comb=spa.fore.comb,Actual=spaLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.text.y=element_text(size=9))
```

```{r}
spa.fore.comb=ts(spa.fore.comb,frequency = 24)
spaLoad_test=ts(spaLoad_test,frequency = 24)

autoplot(spa.fore.comb,color='blue')+
  autolayer(spaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
spa.sna=snaive(spaLoad_test,h=24*7)

MAE=accuracy(spa.fore.comb,spaLoad_test)[3]
  
RelMAE=accuracy(spa.fore.comb,spaLoad_test)[3]/accuracy(as.vector(spa.sna$mean),as.vector(spaLoad_test))[3]

sMAPE=mean(200*(abs(spaLoad_test-spa.fore.comb)/(spaLoad_test+spa.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  spaLoad_test=head(tail(spaLoad,24*7*i),24*7)
  spaLoad_test=as.vector(spaLoad_test)
  
  spaLoad_train1=tail(head(spaLoad1,length(spaLoad1)-24*7*i),24*7*4.25) 
  
  spaLoad_train2=tail(head(spaLoad,length(spaLoad)-24*7*i),24*7*4.25)
  
  spaLoad_train3=tail(head(spaLoad1,length(spaLoad1)-24*7*i),24*7*4.25*12)
  
  
  spa.stlm=spaLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(spa.stlm$mean)
  
  spa.tbats=spaLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(spa.tbats,h=24*7)$mean)
  
  spa.ets=ets(spaLoad_train2,lambda = 0)
  fc3=as.vector(forecast(spa.ets,h=24*7)$mean)
  
  spa.mapa=mapaest(spaLoad_train2,paral=2)
  spa.mapa.for=mapafor(spaLoad_train2,spa.mapa,fh=24*7,outplot=0)
  fc4=as.vector(spa.mapa.for$outfor)
  
  spa.sna=snaive(spaLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,spaLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,spaLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,spaLoad_test)[3]/accuracy(spa.sna$mean,spaLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(spaLoad_test-fore_comb1)/(spaLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(spaLoad_test-fore_comb2)/(spaLoad_test+fore_comb2)))

}

spa.comb.maes=colMeans(MAEs,na.rm=T)
spa.comb.relmaes=colMeans(RelMAEs,na.rm=T)
spa.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
spa.comb.maes
spa.comb.relmaes
spa.comb.smapes
```

```{r}
spa.train.mapa=tail(head(spaLoad,length(spaLoad)-24*7),24*7*4.25)
spa.mapa=mapaest(spa.train.mapa,paral=2)

spa.mapa.for=mapafor(spa.train.mapa,spa.mapa,fh=24*7,outplot=1)
spa.fc6=spa.mapa.for$outfor
```

```{r}
spaLoad_test=ts(as.vector(tail(spaLoad,24*7)),frequency = 24)

autoplot(ts(spa.fc6,frequency = 24),color='blue')+
  autolayer(spaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
spa.fore.comb=0.4*spa.fc1+0.2*spa.fc4+0.2*spa.fc5+0.2*spa.fc6
```

```{r, warning=FALSE}
spaLoad_test=tail(spaLoad,24*7)
spaLoad_test=as.vector(spaLoad_test)

fore=tibble(ID=1:168,fc1=spa.fc1,fc2=spa.fc4,fc3=spa.fc5,fc4=spa.fc6,Comb=spa.fore.comb,Actual=spaLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
spa.fore.comb=ts(spa.fore.comb,frequency = 24)
spaLoad_test=ts(spaLoad_test,frequency = 24)

autoplot(spa.fore.comb,color='blue')+
  autolayer(spaLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
spa.sna=snaive(spaLoad_test,h=24*7)

MAE=accuracy(spa.fore.comb,spaLoad_test)[3]
  
RelMAE=accuracy(spa.fore.comb,spaLoad_test)[3]/accuracy(as.vector(spa.sna$mean),as.vector(spaLoad_test))[3]

sMAPE=mean(200*(abs(spaLoad_test-spa.fore.comb)/(spaLoad_test+spa.fore.comb)))

MAE
RelMAE
sMAPE
```

# Sweden

## Decomposition

```{r}
sweLoad1=msts(swe$ActualTotalLoad,seasonal.periods = c(24,24*7))
sweLoad1=na_ma(sweLoad1)
sweLoad2=msts(swe$ActualTotalLoad,seasonal.periods=c(24,24*7,24*7*4.25))
sweLoad2=na_ma(sweLoad2)

sweLoad=ts(swe$ActualTotalLoad,frequency = 24)
sweLoad=na_ma(sweLoad)
```

```{r}
length(as.vector(tsoutliers(sweLoad)$index))/length(sweLoad)
```

```{r}
out=tsoutliers(sweLoad1)

for (o in out$index){
  sweLoad1[o]=NA
}

out=tsoutliers(sweLoad2)

for (o in out$index){
  sweLoad2[o]=NA
}

out=tsoutliers(sweLoad)

for (o in out$index){
  sweLoad[o]=NA
}
```

```{r}
skimr::skim(sweLoad1)
sweLoad1=na_ma(sweLoad1)
sweLoad2=na_ma(sweLoad2)
sweLoad=na_ma(sweLoad)
```


```{r}
sweLoad_train2=tail(head(sweLoad1,length(sweLoad1)-24*7),24*7*4.25) #1month

sweLoad_train5=tail(head(sweLoad2,length(sweLoad2)-24*7),24*7*4.25*12) #1year
```

1month
```{r, warning=FALSE}
sweLoad_train2 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

1year
```{r}
sweLoad_train5 %>%
  mstl() %>% 
  autoplot() +
  xlab("Time") +
  ggtitle("") +
  theme_bw(base_line_size = 0)
```

## stlm

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  sweLoad_test1=head(tail(sweLoad1,24*7*i),24*7) #2week,1month
  sweLoad_test2=head(tail(sweLoad2,24*7*i),24*7) #3month,6month,1year
  
  sweLoad_train1=tail(head(sweLoad1,length(sweLoad1)-24*7*i),24*7*2+1) #2week
  sweLoad_train2=tail(head(sweLoad1,length(sweLoad1)-24*7*i),24*7*4.25) #1month
  sweLoad_train3=tail(head(sweLoad2,length(sweLoad2)-24*7*i),24*7*4.25*3) #3month
  sweLoad_train4=tail(head(sweLoad2,length(sweLoad2)-24*7*i),24*7*4.25*6) #6month
  sweLoad_train5=tail(head(sweLoad2,length(sweLoad2)-24*7*i),24*7*4.25*12) #1year
  
  swe.stlm1=sweLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  swe.stlm2=sweLoad_train2 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  swe.stlm3=sweLoad_train3 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  swe.stlm4=sweLoad_train4 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  swe.stlm5=sweLoad_train5 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  swe.sna1=snaive(sweLoad_train1,h=24*7)
  swe.sna2=snaive(sweLoad_train2,h=24*7)
  swe.sna3=snaive(sweLoad_train3,h=24*7)
  swe.sna4=snaive(sweLoad_train4,h=24*7)
  swe.sna5=snaive(sweLoad_train5,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(swe.stlm1$mean,sweLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(swe.stlm2$mean,sweLoad_test1)[3]
  MAEs[which(i==1:52),3]=accuracy(swe.stlm3$mean,sweLoad_test2)[3]
  MAEs[which(i==1:52),4]=accuracy(swe.stlm4$mean,sweLoad_test2)[3]
  MAEs[which(i==1:52),5]=accuracy(swe.stlm5$mean,sweLoad_test2)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(swe.stlm1$mean,sweLoad_test1)[3]/accuracy(swe.sna1$mean,sweLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(swe.stlm2$mean,sweLoad_test1)[3]/accuracy(swe.sna2$mean,sweLoad_test1)[3]
  RelMAEs[which(i==1:52),3]=accuracy(swe.stlm3$mean,sweLoad_test2)[3]/accuracy(swe.sna3$mean,sweLoad_test2)[3]
  RelMAEs[which(i==1:52),4]=accuracy(swe.stlm4$mean,sweLoad_test2)[3]/accuracy(swe.sna4$mean,sweLoad_test2)[3]
  RelMAEs[which(i==1:52),5]=accuracy(swe.stlm5$mean,sweLoad_test2)[3]/accuracy(swe.sna5$mean,sweLoad_test2)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(sweLoad_test1-swe.stlm1$mean)/(sweLoad_test1+swe.stlm1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(sweLoad_test1-swe.stlm2$mean)/(sweLoad_test1+swe.stlm2$mean)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(sweLoad_test2-swe.stlm3$mean)/(sweLoad_test2+swe.stlm3$mean)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(sweLoad_test2-swe.stlm4$mean)/(sweLoad_test2+swe.stlm4$mean)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(sweLoad_test2-swe.stlm5$mean)/(sweLoad_test2+swe.stlm5$mean)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs)
```

## TBATS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,2))
RelMAEs=array(NA,c(52,2))
sMAPEs=array(NA,c(52,2))

for (i in 1:52){
  print(i)
  sweLoad_test1=head(tail(sweLoad1,24*7*i),24*7) #2week,1month
  
  sweLoad_train1=tail(head(sweLoad1,length(sweLoad1)-24*7*i),24*7*2+1) #2week
  sweLoad_train2=tail(head(sweLoad1,length(sweLoad1)-24*7*i),24*7*4.25) #1month
  
  
  swe.tbats1=sweLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  swe.tbats.fore1=forecast(swe.tbats1,h=24*7)
  
  swe.tbats2=sweLoad_train2 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  swe.tbats.fore2=forecast(swe.tbats2,h=24*7)
  
  
  swe.sna1=snaive(sweLoad_train1,h=24*7)
  swe.sna2=snaive(sweLoad_train2,h=24*7)

  
  MAEs[which(i==1:52),1]=accuracy(swe.tbats.fore1$mean,sweLoad_test1)[3]
  MAEs[which(i==1:52),2]=accuracy(swe.tbats.fore2$mean,sweLoad_test1)[3]

  
  RelMAEs[which(i==1:52),1]=accuracy(swe.tbats.fore1$mean,sweLoad_test1)[3]/accuracy(swe.sna1$mean,sweLoad_test1)[3]
  RelMAEs[which(i==1:52),2]=accuracy(swe.tbats.fore2$mean,sweLoad_test1)[3]/accuracy(swe.sna2$mean,sweLoad_test1)[3]


  sMAPEs[which(i==1:52),1]=mean(200*(abs(sweLoad_test1-swe.tbats.fore1$mean)/(sweLoad_test1+swe.tbats.fore1$mean)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(sweLoad_test1-swe.tbats.fore2$mean)/(sweLoad_test1+swe.tbats.fore2$mean)))

}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## ETS

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(52,5))
RelMAEs=array(NA,c(52,5))
sMAPEs=array(NA,c(52,5))

for (i in 1:52){
  print(i)
  sweLoad_test=head(tail(sweLoad,24*7*i),24*7)
  sweLoad_train1=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*2+1)
  sweLoad_train2=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*4.25)
  sweLoad_train3=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*4.25*3)
  sweLoad_train4=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*4.25*6)
  sweLoad_train5=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*4.25*12)
  
  swe.ets1=ets(sweLoad_train1,lambda = 0)
  fc1=forecast(swe.ets1,h=24*7)$mean
  
  swe.ets2=ets(sweLoad_train2,lambda = 0)
  fc2=forecast(swe.ets2,h=24*7)$mean
  
  swe.ets3=ets(sweLoad_train3,lambda = 0)
  fc3=forecast(swe.ets3,h=24*7)$mean
  
  swe.ets4=ets(sweLoad_train4,lambda = 0)
  fc4=forecast(swe.ets4,h=24*7)$mean
  
  swe.ets5=ets(sweLoad_train5,lambda = 0)
  fc5=forecast(swe.ets5,h=24*7)$mean
  
  
  swe.sna=snaive(sweLoad_train1,h=24*7)
  
  MAEs[which(i==1:52),1]=accuracy(fc1,sweLoad_test)[3]
  MAEs[which(i==1:52),2]=accuracy(fc2,sweLoad_test)[3]
  MAEs[which(i==1:52),3]=accuracy(fc3,sweLoad_test)[3]
  MAEs[which(i==1:52),4]=accuracy(fc4,sweLoad_test)[3]
  MAEs[which(i==1:52),5]=accuracy(fc5,sweLoad_test)[3]
  
  RelMAEs[which(i==1:52),1]=accuracy(fc1,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]
  RelMAEs[which(i==1:52),2]=accuracy(fc2,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]
  RelMAEs[which(i==1:52),3]=accuracy(fc3,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]
  RelMAEs[which(i==1:52),4]=accuracy(fc4,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]
  RelMAEs[which(i==1:52),5]=accuracy(fc5,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]
  
  sMAPEs[which(i==1:52),1]=mean(200*(abs(sweLoad_test-fc1)/(sweLoad_test+fc1)))
  sMAPEs[which(i==1:52),2]=mean(200*(abs(sweLoad_test-fc2)/(sweLoad_test+fc2)))
  sMAPEs[which(i==1:52),3]=mean(200*(abs(sweLoad_test-fc3)/(sweLoad_test+fc3)))
  sMAPEs[which(i==1:52),4]=mean(200*(abs(sweLoad_test-fc4)/(sweLoad_test+fc4)))
  sMAPEs[which(i==1:52),5]=mean(200*(abs(sweLoad_test-fc5)/(sweLoad_test+fc5)))
}

colMeans(MAEs)
colMeans(RelMAEs)
colMeans(sMAPEs,na.rm=T)
```

## Regression with Arima errors

```{r}
sweweather=read_csv("swe_weather.csv")
sweweather$TimeUTC=dmy_hm(sweweather$TimeUTC)
sweweather$T=as.double(sweweather$T)
swe=left_join(swe,sweweather,by="TimeUTC")

sweholiday=read_csv("swe_holiday.csv")
sweholiday$TimeUTC=dmy_hm(sweholiday$TimeUTC)
sweholiday$Holiday=as.integer(sweholiday$Holiday)
swe=left_join(swe,sweholiday,by="TimeUTC")
```

```{r}
sweTem=ts(swe$T,frequency=24)
sweTem=na_ma(sweTem)
sweHoli=ts(swe$Holiday,frequency=24)
```

## Final forecasts

### Round 1

```{r}
swe.train.stlm=tail(head(sweLoad1,length(sweLoad1)-24*7),24*7*4.25)
sweLoad_test=tail(sweLoad,24*7)

swe.stlm=swe.train.stlm %>% 
  stlm(lambda=0) %>% 
  forecast(h=24*7)

swe.fc1=as.vector(swe.stlm$mean)
```

```{r}
sweLoad_train=tail(head(sweLoad,length(sweLoad)-24*7),24*7*4.25)
sweHoli_train=tail(head(sweHoli,length(sweHoli)-24*7),24*7*4.25)
sweHoli_train=na_ma(sweHoli_train)
sweHoli_test=tail(sweHoli,24*7)
sweHoli_test=na_ma(sweHoli_test)
```

```{r}
swe.rarima=auto.arima(sweLoad_train,xreg=sweHoli_train)
swe.rarima.for=forecast(swe.rarima,xreg=sweHoli_test)
swe.fc2=as.vector(swe.rarima.for$mean)
```

```{r}
autoplot(swe.rarima.for$mean,color='blue')+
  autolayer(sweLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")
```

```{r}
swe.fore.comb=(swe.fc1+swe.fc2)/2
```

```{r, warning=FALSE}
sweLoad_test=tail(sweLoad,24*7)
sweLoad_test=as.vector(sweLoad_test)

fore=tibble(ID=1:168,fc1=swe.fc1,fc2=swe.fc2,Comb=swe.fore.comb,Actual=sweLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#9EF8EE","blue","black"),
                     labels=c("STLM",
                              "Holiday Errors",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```


```{r}
swe.fore.comb=ts(swe.fore.comb,frequency = 24)
sweLoad_test=ts(sweLoad_test,frequency = 24)

autoplot(swe.fore.comb,color='blue')+
  autolayer(sweLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```


```{r}
swe.sna=snaive(sweLoad_test,h=24*7)

MAE=accuracy(swe.fore.comb,sweLoad_test)[3]
  
RelMAE=accuracy(swe.fore.comb,sweLoad_test)[3]/accuracy(as.vector(swe.sna$mean),as.vector(sweLoad_test))[3]

sMAPE=mean(200*(abs(sweLoad_test-swe.fore.comb)/(sweLoad_test+swe.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 2

forecast combination of stlm, tbats, arima and ets

```{r}
# swe.train.stlm=tail(head(sweLoad1,length(sweLoad1)-24*7),24*7*4.25)
# 
# swe.stlm=swe.train.stlm %>% 
#   stlm(lambda=0) %>% 
#   forecast(h=24*7)
# 
# swe.fc1=as.vector(swe.stlm$mean)
```

```{r}
sweLoad_train=tail(head(sweLoad,length(sweLoad)-24*7),24*7*4.25)
sweTem_train=tail(head(sweTem,length(sweTem)-24*7),24*7*4.25)
sweTem_test=tail(sweTem,24*7)
```

```{r}
swe.rarima=auto.arima(sweLoad_train,xreg=sweTem_train)
swe.rarima.for=forecast(swe.rarima,xreg=sweTem_test)
swe.fc3=as.vector(swe.rarima.for$mean)
```

```{r}
swe.tbats.train=tail(head(sweLoad1,length(sweLoad1)-24*7),24*7*4.25)
swe.tbats=swe.train.stlm %>% 
  tbats(use.box.cox = F,
        use.trend = T,
        use.damped.trend = T)
```

```{r}
swe.tbats.fore=forecast(swe.tbats,h=24*7)
swe.fc4=as.vector(swe.tbats.fore$mean)
```

```{r}
swe.ets.train=tail(head(sweLoad,length(sweLoad)-24*7),24*7*4.25*12)
swe.ets=ets(swe.ets.train,lambda = 0)
swe.fc5=as.vector(forecast(swe.ets,h=24*7)$mean)
```

```{r}
fore=tibble(fc1=swe.fc1,fc2=swe.fc4,fc3=swe.fc2,fc4=swe.fc3,fc5=swe.fc5)
#stlm,tbats,holiday,temperature,ets
```

```{r}
#swe.fore.comb=rowMeans(fore)

swe.fore.comb=vector()

for (i in 1:168){
  swe.fore.comb[i]=(sum(fore[i,])-min(fore[i,])-max(fore[i,]))/(ncol(fore)-2)
}

```

```{r, warning=FALSE}
sweLoad_test=tail(sweLoad,24*7)
sweLoad_test=as.vector(sweLoad_test)

fore=tibble(ID=1:168,fc1=swe.fc1,fc2=swe.fc4,fc3=swe.fc2,fc4=swe.fc3,fc5=swe.fc5,Comb=swe.fore.comb,Actual=sweLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","#348888","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "Holiday Errors",
                              "Temperature Errors",
                              "ETS",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
swe.fore.comb=ts(swe.fore.comb,frequency = 24)
sweLoad_test=ts(sweLoad_test,frequency = 24)

autoplot(swe.fore.comb,color='blue')+
  autolayer(sweLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
swe.sna=snaive(sweLoad_test,h=24*7)

MAE=accuracy(swe.fore.comb,sweLoad_test)[3]
  
RelMAE=accuracy(swe.fore.comb,sweLoad_test)[3]/accuracy(as.vector(swe.sna$mean),as.vector(sweLoad_test))[3]

sMAPE=mean(200*(abs(sweLoad_test-swe.fore.comb)/(sweLoad_test+swe.fore.comb)))

MAE
RelMAE
sMAPE
```

### Round 3

```{r, results='hide', warning=FALSE, eval=FALSE}
MAEs=array(NA,c(15,2))
RelMAEs=array(NA,c(15,2))
sMAPEs=array(NA,c(15,2))

for (i in 2:16){
  print(i)
  sweLoad_test=head(tail(sweLoad,24*7*i),24*7)
  sweLoad_test=as.vector(sweLoad_test)
  
  sweLoad_train1=tail(head(sweLoad1,length(sweLoad1)-24*7*i),24*7*4.25) 
  
  sweLoad_train2=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*4.25)
  
  sweLoad_train4=tail(head(sweLoad,length(sweLoad)-24*7*i),24*7*4.25*12)
  
  swe.stlm=sweLoad_train1 %>% 
    stlm(lambda=0) %>% 
    forecast(h=24*7)
  
  fc1=as.vector(swe.stlm$mean)
  
  swe.tbats=sweLoad_train1 %>% 
    tbats(use.box.cox = F,
          use.trend = T,
          use.damped.trend = T)
  
  fc2=as.vector(forecast(swe.tbats,h=24*7)$mean)
  
  swe.ets=ets(sweLoad_train4,lambda = 0)
  fc3=as.vector(forecast(swe.ets,h=24*7)$mean)
  
  swe.mapa=mapaest(sweLoad_train2,paral=2)
  swe.mapa.for=mapafor(sweLoad_train2,swe.mapa,fh=24*7,outplot=0)
  fc4=as.vector(swe.mapa.for$outfor)
  
  swe.sna=snaive(sweLoad_train2,h=24*7)
  
  fore_comb1=(fc1+fc2+fc3+fc4)/4
  fore_comb2=0.4*fc1+0.2*fc2+0.2*fc3+0.2*fc4

   MAEs[which(i==2:16),1]=accuracy(fore_comb1,sweLoad_test)[3]
   MAEs[which(i==2:16),2]=accuracy(fore_comb2,sweLoad_test)[3]
  
   RelMAEs[which(i==2:16),1]=accuracy(fore_comb1,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]
   RelMAEs[which(i==2:16),2]=accuracy(fore_comb2,sweLoad_test)[3]/accuracy(swe.sna$mean,sweLoad_test)[3]

  sMAPEs[which(i==2:16),1]=mean(200*(abs(sweLoad_test-fore_comb1)/(sweLoad_test+fore_comb1)))
  sMAPEs[which(i==2:16),2]=mean(200*(abs(sweLoad_test-fore_comb2)/(sweLoad_test+fore_comb2)))

}

swe.comb.maes=colMeans(MAEs,na.rm=T)
swe.comb.relmaes=colMeans(RelMAEs,na.rm=T)
swe.comb.smapes=colMeans(sMAPEs,na.rm=T)
```

```{r}
swe.comb.maes
swe.comb.relmaes
swe.comb.smapes
```

```{r}
swe.train.mapa=tail(head(sweLoad,length(sweLoad)-24*7),24*7*4.25)
swe.mapa=mapaest(swe.train.mapa,paral=2)

swe.mapa.for=mapafor(swe.train.mapa,swe.mapa,fh=24*7,outplot=1)
swe.fc6=swe.mapa.for$outfor
```

```{r}
sweLoad_test=ts(as.vector(tail(sweLoad,24*7)),frequency = 24)

autoplot(ts(swe.fc6,frequency = 24),color='blue')+
  autolayer(sweLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
swe.fore.comb=0.4*swe.fc1+0.2*swe.fc4+0.2*swe.fc5+0.2*swe.fc6
```

```{r, warning=FALSE}
sweLoad_test=tail(sweLoad,24*7)
sweLoad_test=as.vector(sweLoad_test)

fore=tibble(ID=1:168,fc1=swe.fc1,fc2=swe.fc4,fc3=swe.fc5,fc4=swe.fc6,Comb=swe.fore.comb,Actual=sweLoad_test)

fore %>% 
  gather(Methods,Value,fc1:Actual,factor_key=TRUE) %>% 
  ggplot()+
  geom_line(aes(x=ID,y=Value,color=Methods))+
  scale_color_manual(values=c("#F24405","#FA7F08","#9EF8EE",
                              "#22BABB","blue","black"),
                     labels=c("STLM",
                              "TBATS",
                              "ETS",
                              "MAPA",
                              "Combination",
                              "Actual Value"))+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  theme_stata()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8))
```

```{r}
swe.fore.comb=ts(swe.fore.comb,frequency = 24)
sweLoad_test=ts(sweLoad_test,frequency = 24)

autoplot(swe.fore.comb,color='blue')+
  autolayer(sweLoad_test, color="black")+
  ggtitle("")+
  guides(color=guide_legend(title=""))+
  theme_stata()+
  theme(legend.position = "none")+
  labs(x="Next week hourly forecasts",y="Electricity load data")+
  scale_x_continuous(breaks=NULL)
```

```{r}
swe.sna=snaive(sweLoad_test,h=24*7)

MAE=accuracy(swe.fore.comb,sweLoad_test)[3]
  
RelMAE=accuracy(swe.fore.comb,sweLoad_test)[3]/accuracy(as.vector(swe.sna$mean),as.vector(sweLoad_test))[3]

sMAPE=mean(200*(abs(sweLoad_test-swe.fore.comb)/(sweLoad_test+swe.fore.comb)))

MAE
RelMAE
sMAPE
```
